{% extends "base.html" %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <h3 class="mb-4">{{ titulo }}</h3>

    <div class="d-flex justify-content-between align-items-center mb-3">
        
        {# Botón (Opcional, si permites crear alertas manualmente) #}
        {% if not read_only %}
            <a href="{% url 'inventario:crear_alerta' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Nueva Alerta
            </a>
        {% endif %}
    </div>

    {# INICIO DEL FORMULARIO DE BÚSQUEDA Y FILTROS #}
    <form id="filters-form" class="row g-2 mb-3" method="get">
        
        {# CAMPO DE BÚSQUEDA Y BOTÓN APLICAR #}
        <div class="col-md-4">
            <div class="input-group">
                <input type="search"
                        name="q"
                        id="q-input"
                        class="form-control"
                        placeholder="Buscar por insumo, tipo o mensaje..."
                        value="{{ q|default:'' }}">
                
                <button type="submit" class="btn btn-primary" id="apply-filter-btn">
                    <i class="bi bi-search"></i> Aplicar
                </button>
            </div>
        </div>

        {# SELECT DE ORDENAR POR (Puedes añadir más opciones si lo necesitas) #}
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text">Ordenar por</span>
                <select name="sort" id="sort-select" class="form-select">
                    <option value="fecha"     {% if sort == 'fecha' %}selected{% endif %}>Fecha</option>
                    <option value="insumo"    {% if sort == 'insumo' %}selected{% endif %}>Insumo</option>
                    <option value="tipo"      {% if sort == 'tipo' %}selected{% endif %}>Tipo</option>
                </select>
            </div>
        </div>

        {# NUEVO: FILTRO POR TIPO DE ALERTA #}
        <div class="col-md-2">
            <select name="tipo" id="tipo-select" class="form-select">
                <option value="">Todos los tipos</option>
                {% for value, label in tipos_alerta %}
                    <option value="{{ value }}" {% if tipo_filtro == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        {# SELECT DE ORDEN #}
        <div class="col-md-2">
            <select name="order" id="order-select" class="form-select">
                <option value="asc"  {% if order != 'desc' %}selected{% endif %}>Ascendente</option>
                <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descendente</option>
            </select>
        </div>

        {# SELECT DE ELEMENTOS POR PÁGINA #}
        <div class="col-md-2">
            <select name="per_page" id="per-page-select" class="form-select">
                <option value="10"  {% if per_page == 10 %}selected{% endif %}>10 por página</option>
                <option value="20"  {% if per_page == 20 %}selected{% endif %}>20 por página</option>
                <option value="25"  {% if per_page == 25 %}selected{% endif %}>25 por página</option>
                <option value="50"  {% if per_page == 50 %}selected{% endif %}>50 por página</option>
            </select>
        </div>
        
        {# NUEVO: FILTRO MOSTRAR INACTIVAS (CHECKBOX) #}
        <div class="col-md-1 d-flex align-items-center justify-content-end">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="mostrarInactivasSwitch"
                    name="mostrar_inactivas" value="1" 
                    {% if mostrar_inactivas %}checked{% endif %}
                    onchange="document.getElementById('filters-form').submit();">
                <label class="form-check-label" for="mostrarInactivasSwitch" title="Mostrar alertas marcadas como revisadas/inactivas.">
                    Historial
                </label>
            </div>
        </div>
        
        {# El hidden field mostrar_inactivas ya no es necesario aquí, la lógica la lleva el switch o se omite si está desmarcado. #}
        {# Necesitamos el hidden de página para que no vuelva a la página 1 cuando se usan los filtros de arriba #}
        <input type="hidden" name="page" id="page-input" value="{{ alertas.number }}">
    </form>
    {# FIN DEL FORMULARIO #}

    {# MOSTRAR FILTRO ACTIVO #}
    {% if tipo_filtro %}
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3" role="alert">
        <div>
            <strong>Filtro activo:</strong>
            {% for value, label in tipos_alerta %}
                {% if value == tipo_filtro %}
                    <span class="badge bg-primary ms-2">{{ label }}</span>
                {% endif %}
            {% endfor %}
        </div>
        <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if mostrar_inactivas %}mostrar_inactivas=1&{% endif %}" class="btn btn-sm btn-outline-info">
            <i class="bi bi-x"></i> Limpiar filtro
        </a>
    </div>
    {% endif %}

    <div id="results">
        {% include "inventario/partials/alertas_results.html" %}
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
    const form = document.getElementById('filters-form');
    const results = document.getElementById('results');
    if (!form || !results) return;

    const pageInput = document.getElementById('page-input');
    const tipoSelect = document.getElementById('tipo-select');
    const sortSelect = document.getElementById('sort-select');
    const orderSelect = document.getElementById('order-select');
    const perPageSelect = document.getElementById('per-page-select');

    const buildURL = () => {
        const params = new URLSearchParams(new FormData(form));
        return `${location.pathname}?${params.toString()}`;
    };

    async function loadAjax(url){
        try {
            const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!resp.ok) return;
            const data = await resp.json();
            results.innerHTML = data.html;
            history.replaceState({}, '', url);
        } catch (err) {
            console.error('Error AJAX alertas:', err);
        }
    }

    const debounce = (fn, ms = 300) => {
        let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    };

    // Envío del formulario (Aplicar filtros)
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (pageInput) pageInput.value = '1';
        loadAjax(buildURL());
    });

    // Búsqueda mientras escribe
    const qInput = form.querySelector('input[name="q"]');
    qInput?.addEventListener('input', debounce(() => {
        if (pageInput) pageInput.value = '1';
        loadAjax(buildURL());
    }));

    // Cambios en filtros (tipo, sort, order, per_page)
    [tipoSelect, sortSelect, orderSelect, perPageSelect].forEach(el => {
        if (!el) return;
        el.addEventListener('change', () => {
            if (pageInput) pageInput.value = '1';
            loadAjax(buildURL());
        });
    });

    // Paginación por AJAX (links con data-ajax-link en el partial)
    results.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-ajax-link]');
        if (!a) return;
        e.preventDefault();
        loadAjax(a.href);
    });
})();
</script>
{% endblock %}