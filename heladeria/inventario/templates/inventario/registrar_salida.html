{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <h3 class="mb-0">{{ titulo }}</h3>
                <button id="add-line-salida" type="button" class="btn btn-sm btn-danger">
                    <i class="bi bi-plus-circle"></i> Agregar Línea
                </button>
            </div>

            <div class="card-body">
                <form method="post" novalidate id="salida-form">
                    {% csrf_token %}
                    {{ formset.management_form }}
                    
                    {# MENSAJE DE ORDEN #}
                    {% if orden %}
                        <div class="alert alert-warning">
                            Procesando la **Orden #{{ orden.id }}**. Selecciona el lote de origen para cada insumo.
                            <input type="hidden" name="orden_id" value="{{ orden.id }}">
                        </div>
                    {% endif %}
                    
                    {# ERRORES GLOBALES #}
                    {% if formset.non_form_errors %}
                        <div class="alert alert-danger">
                            <strong>Errores Generales:</strong>
                            <ul>
                                {% for error in formset.non_form_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <div id="formset-body-salida">
                        {% for f in formset %}
                            {% include "inventario/partials/salida_linea_form.html" with form=f prefix=forloop.counter0 %}
                        {% endfor %}
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{% url 'inventario:listar_movimientos' %}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-save"></i> Registrar Salida
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{# ----------------------------------------------------- #}
{# TEMPLATE OCULTO Y LÓGICA JAVASCRIPT #}
{# ----------------------------------------------------- #}
<script type="text/template" id="empty-form-row-salida">
    {% include "inventario/partials/salida_linea_form.html" with form=formset.empty_form prefix="__prefix__" %}
</script>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetBody = document.getElementById('formset-body-salida');
    const addLineBtn = document.getElementById('add-line-salida');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    const emptyFormTpl = document.getElementById('empty-form-row-salida').textContent;

    function setDisabled(element, disabled) {
        if (element) {
            element.disabled = disabled;
            element.closest('.form-control, .form-select, .form-check, .input-group')?.classList.toggle('disabled', disabled); 
        }
    }

    // Función que verifica si todos los campos requeridos en un contenedor están llenos
    function checkStepCompletion(container) {
        let allRequiredFilled = true;
        
        container.querySelectorAll('select, input:not([type="hidden"]), textarea').forEach(element => {
            if (element.required) {
                if (!element.value || element.value === '') {
                    allRequiredFilled = false;
                }
            }
        });
        return allRequiredFilled;
    }
    
    function setupSequentialLogic(row) {
        const rowElement = row.closest('.movimiento-card');
        if (!rowElement) return;

        // Contenedores de Pasos
        const step1Container = rowElement.querySelector('[data-lock-step="1"]'); // Insumo, Lote Origen
        const step2Container = rowElement.querySelector('[data-lock-step="2"]'); // Cantidad, Ubicación, Fecha
        const step3Container = rowElement.querySelector('[data-lock-step="3"]'); // Observaciones

        function applyLockState() {
            // Bloqueo Paso 2
            const step1Complete = checkStepCompletion(step1Container);
            setLockState(step2Container, !step1Complete);
            
            // Bloqueo Paso 3
            const step2Complete = step1Complete && checkStepCompletion(step2Container);
            setLockState(step3Container, !step2Complete);
        }

        function setLockState(element, locked) {
            if (!element) return;
            element.querySelectorAll('input, select, textarea').forEach(el => setDisabled(el, locked));
            element.style.pointerEvents = locked ? 'none' : 'auto';
            element.style.opacity = locked ? '0.7' : '1';
        }
        
        // --- ASIGNACIÓN DE EVENTOS ---
        step1Container.addEventListener('change', applyLockState);
        step1Container.addEventListener('input', applyLockState);
        if (step2Container) step2Container.addEventListener('change', applyLockState);
        
        applyLockState();
    }

    // --- MANEJO DE FORMSET: Agregar y Eliminar Líneas ---
    
    addLineBtn.addEventListener('click', function() {
        const index = parseInt(totalForms.value, 10);
        const newFormHtml = emptyFormTpl.replace(/__prefix__/g, index);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml.trim();
        const newRow = tempDiv.firstChild;
        
        formsetBody.appendChild(newRow);
        totalForms.value = index + 1;
        
        setupSequentialLogic(newRow); 
    });

    // Delegación para eliminar líneas
    formsetBody.addEventListener('click', (e) => {
        const delBtn = e.target.closest('.del-line');
        if (delBtn) {
            const row = delBtn.closest('.movimiento-card');
            const deleteInput = row.querySelector('[name$="-DELETE"]');
            
            if (deleteInput) {
                deleteInput.checked = true;
                row.style.display = 'none';
            }
        }
    });

    document.querySelectorAll('.movimiento-card').forEach(setupSequentialLogic);
});
</script>
{% endblock extra_js %}