<div class="card mb-3 movimiento-card border-{{ form.errors|yesno:'danger,success' }} js-movement-line">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0 text-success">Nueva L√≠nea de Entrada</h6>
        <div class="delete-controls">
            {# Campos ocultos de gesti√≥n #}
            {{ form.id }}
            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
            {# Bot√≥n de Marcar para Eliminar #}
            {% if formset.can_delete %}
                <button type="button" class="btn btn-sm btn-outline-secondary mark-delete-line" title="‚úì Marcar para eliminar (se eliminar√° al guardar)">
                    <i class="bi bi-check-square"></i> ‚úì Marcar
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger del-line" title="üóëÔ∏è Eliminar l√≠nea">
                    <i class="bi bi-trash"></i> üóëÔ∏è
                </button>
                {# Campo DELETE oculto #}
                <div style="display: none;">{{ form.DELETE }}</div>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        
        {# --- SECCI√ìN 1: PRODUCTO Y REGISTRO --- #}
        <div class="row g-3 mb-4 p-3 border rounded bg-light-subtle">
            <div class="col-md-6">
                <label class="form-label required small">{{ form.insumo.label }}</label>
                {{ form.insumo }}
                {% for error in form.insumo.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
                <label class="form-label required small">{{ form.ubicacion.label }}</label>
                {{ form.ubicacion }}
                {% for error in form.ubicacion.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
            
            {# CANTIDAD Y ASISTENCIA DE STOCK (Ajuste de columnas: de 6/6 a 3/3 para caber) #}
            <div class="col-md-3">
                <label class="form-label required small">{{ form.cantidad.label }}</label>
                {{ form.cantidad }}
                {% for error in form.cantidad.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
            
            {# ‚ö†Ô∏è CONTENEDOR DE ASISTENCIA DE STOCK #}
            <div class="col-md-3 d-flex align-items-end"> 
                <div class="js-stock-info-display w-100">
                    <span class="text-muted small">Seleccione un insumo.</span>
                </div>
            </div>
            {# FIN CANTIDAD Y ASISTENCIA DE STOCK #}

            <div class="col-md-6">
                <label class="form-label required small">{{ form.fecha.label }}</label>
                {{ form.fecha }}
                {% for error in form.fecha.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
        </div>

        {# --- SECCI√ìN 2: DATOS DEL LOTE (Proveedor y Expiraci√≥n) --- #}
        <div class="row g-3 mb-3 p-3 border rounded">
            <h6 class="text-secondary small border-bottom pb-2">Datos del Lote</h6>
            
            <div class="col-md-6">
                <label class="form-label small">{{ form.proveedor.label }}</label>
                {{ form.proveedor }}
                {% for error in form.proveedor.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
            
            <div class="col-md-6">
                <label class="form-label required small">{{ form.fecha_expiracion.label }}</label>
                {{ form.fecha_expiracion }}
                {% for error in form.fecha_expiracion.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
        </div>

        {# --- SECCI√ìN 3: OBSERVACIONES --- #}
        <div class="row g-3">
            <div class="col-md-12">
                <label class="form-label small">{{ form.observaciones.label }}</label>
                {{ form.observaciones }}
                {% for error in form.observaciones.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
            </div>
            
            {# Errores de formulario no asociados a campos #}
            {% if form.non_field_errors %}
                <div class="col-12">
                    <div class="alert alert-danger small">
                        <strong>Error de L√≠nea:</strong> {{ form.non_field_errors|join:", " }}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>