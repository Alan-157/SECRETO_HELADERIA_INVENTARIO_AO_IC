{# inventario/partials/reporte_disponibilidad_results.html #}

<div class="mb-3">
  <h5 class="fw-bold">
    Reporte de Disponibilidad de Insumos - {{ today|date:"Y-m-d" }}
  </h5>
</div>

{% for bloque in categorias %}
  <div class="mt-4">
    <div class="fw-semibold mb-2">
      Categoría: {{ bloque.categoria.nombre }}
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>Insumo</th>
            <th>Unidad</th>

            {% if show_precio_unitario %}
              <th class="text-end">Precio Unitario</th>
            {% endif %}

            {% if show_stock_total %}
              <th class="text-end">Stock Total</th>
            {% endif %}

            {% if show_lotes %}
              <th class="text-center">Lotes con Stock</th>
            {% endif %}

            {% if show_prox_venc %}
              <th class="text-center">Próx. Vencimiento</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
          {% for ins in bloque.insumos %}
            <tr>
              <td class="fw-semibold">{{ ins.nombre }}</td>
              <td>{{ ins.unidad_medida.nombre|default:"" }}</td>

              {% if show_precio_unitario %}
                <td class="text-end">
                  {{ ins.precio_unitario|floatformat:0 }}
                </td>
              {% endif %}

              {% if show_stock_total %}
                <td class="text-end">
                  {{ ins.stock_total|default:0|floatformat:2 }}
                </td>
              {% endif %}

              {% if show_lotes %}
                <td class="text-center">
                  {{ ins.lotes_vis|length|default:0 }}
                </td>
              {% endif %}

              {% if show_prox_venc %}
                <td class="text-center">
                  {% if ins.prox_vencimiento %}
                    {{ ins.prox_vencimiento|date:"Y-m-d" }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              {% endif %}
            </tr>

            {# Si quieres listar lotes debajo, mantenlo opcional #}
            {% if show_lotes and ins.lotes_vis %}
              <tr class="bg-light">
                <td colspan="{{ colspan_lotes }}">
                  <small class="text-muted">
                    Lotes con stock:
                    {% for l in ins.lotes_vis %}
                      {% if l.cantidad_actual > 0 %}
                        #{{ l.id }} ({{ l.bodega.nombre }} · {{ l.fecha_expiracion|date:"Y-m-d" }} · {{ l.cantidad_actual }}){% if not forloop.last %}, {% endif %}
                      {% endif %}
                    {% endfor %}
                  </small>
                </td>
              </tr>
            {% endif %}
          {% empty %}
            <tr>
              <td colspan="{{ colspan_lotes }}" class="text-center text-muted py-3">
                Sin insumos en esta categoría.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endfor %}

<hr class="my-4">

<div class="d-flex justify-content-end gap-4 fw-semibold">
  <div>Stock total: {{ total_stock|floatformat:2 }}</div>
  <div>Precio total: {{ total_valor|floatformat:0 }}</div>
</div>
