{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <h3 class="mb-0">{{ titulo }}</h3>
  <a href="{% url 'inventario:crear_orden' %}" class="btn btn-primary">+ Nueva orden</a>
</div>

<form id="filtros" class="row g-2 align-items-center mb-3" method="get">
  <div class="col-12 col-md">
    <input class="form-control" type="text" name="q" value="{{ q|default_if_none:'' }}"
           placeholder="Buscar por creador (nombre o correo)…">
  </div>

  <div class="col-auto">
    <select class="form-select" name="estado">
      <option value="">Estado</option>
      {% for e in ESTADOS_ORDEN %}
        <option value="{{ e }}" {% if estado == e %}selected{% endif %}>{{ e|title|cut:"_" }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-auto">
    <select class="form-select" name="sort">
      <option value="id" {% if sort == 'id' %}selected{% endif %}>Orden #</option>
      <option value="usuario" {% if sort == 'usuario' %}selected{% endif %}>Creador</option>
      <option value="estado" {% if sort == 'estado' %}selected{% endif %}>Estado</option>
      <option value="fecha" {% if sort == 'fecha' %}selected{% endif %}>Fecha</option>
      <option value="creado" {% if sort == 'creado' %}selected{% endif %}>Creado</option>
      <option value="actualizado" {% if sort == 'actualizado' %}selected{% endif %}>Actualizado</option>
    </select>
  </div>

  <div class="col-auto">
    <select class="form-select" name="order">
      <option value="asc" {% if order == 'asc' %}selected{% endif %}>A-Z / ↑</option>
      <option value="desc" {% if order == 'desc' or not order %}selected{% endif %}>Z-A / ↓</option>
    </select>
  </div>

  <div class="col-auto">
    <select class="form-select" name="per_page">
      <option value="5" {% if per_page == 5 %}selected{% endif %}>5 por página</option>
      <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
      <option value="20" {% if per_page == 20 %}selected{% endif %}>20 por página</option>
    </select>
  </div>

  <div class="col-auto">
    <button class="btn btn-outline-secondary" type="submit">Aplicar</button>
  </div>
</form>

<div id="list-container">
  {% include "inventario/partials/ordenes_results.html" %}
</div>

<script>
  // Envío automático al cambiar filtros
  document.getElementById('filtros').addEventListener('change', e => {
    if (['SELECT', 'INPUT'].includes(e.target.tagName)) e.currentTarget.submit();
  });

  // Paginación y actualizar estado por AJAX (usa data-ajax-link / data-ajax-form en partial)
  document.addEventListener('click', async (e) => {
    const a = e.target.closest('a[data-ajax-link]');
    if (!a) return;
    e.preventDefault();
    const url = a.getAttribute('href');
    const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    const data = await resp.json();
    document.getElementById('list-container').innerHTML = data.html;
    window.history.replaceState({}, '', url);
  });

  document.addEventListener('submit', async (e)=>{
    const f = e.target.closest('form[data-ajax-form]');
    if (!f) return;
    e.preventDefault();
    const url = f.getAttribute('action');
    const formData = new FormData(f);
    const resp = await fetch(url, {
      method: 'POST',
      body: formData,
      headers: {'X-Requested-With':'XMLHttpRequest'}
    });
    if (resp.ok) {
      const current = new URL(location.href);
      const reload = await fetch(current.pathname + '?' + current.searchParams.toString(), {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const data = await reload.json();
      document.getElementById('list-container').innerHTML = data.html;
    }
  });
</script>

{% endblock %}
