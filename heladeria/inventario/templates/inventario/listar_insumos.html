{# inventario/listar_insumos.html #}
{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">{{ titulo }}</h3>

  {% if not read_only %}
    <a href="{% url 'inventario:crear_insumo' %}" class="btn btn-primary">
      ➕ Nuevo Insumo
    </a>
  {% endif %}
</div>

<form id="filters-form" class="row g-2 mb-3" method="get">
  <div class="col-md-4">
    <input type="search"
           name="q"
           id="q-input"
           class="form-control"
           placeholder="Buscar por nombre o categoría..."
           value="{{ q|default:'' }}">
  </div>

  <div class="col-md-3">
    <div class="input-group">
      <span class="input-group-text">Ordenar por</span>
      <select name="sort" id="sort-select" class="form-select">
        <option value="">Por defecto</option>
        <option value="nombre"   {% if sort == 'nombre' %}selected{% endif %}>Nombre</option>
        <option value="categoria"{% if sort == 'categoria' %}selected{% endif %}>Categoría</option>
        <option value="stock"    {% if sort == 'stock' %}selected{% endif %}>Stock actual</option>
      </select>
    </div>
  </div>

  <div class="col-md-2">
    <select name="order" id="order-select" class="form-select">
      <option value="asc"  {% if order != 'desc' %}selected{% endif %}>Ascendente</option>
      <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descendente</option>
    </select>
  </div>

  <div class="col-md-2">
    <select name="per_page" id="per-page-select" class="form-select">
      <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
      <option value="25" {% if per_page == 25 %}selected{% endif %}>25 por página</option>
      <option value="50" {% if per_page == 50 %}selected{% endif %}>50 por página</option>
      <option value="100" {% if per_page == 100 %}selected{% endif %}>100 por página</option>
    </select>
  </div>

  <input type="hidden" name="page" id="page-input" value="{{ insumos.number }}">
</form>

<div id="results">
  {% include "inventario/partials/insumos_results.html" %}
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form           = document.getElementById('filters-form');
  const results        = document.getElementById('results');
  const qInput         = document.getElementById('q-input');
  const sortSelect     = document.getElementById('sort-select');
  const orderSelect    = document.getElementById('order-select');
  const perPageSelect  = document.getElementById('per-page-select');
  const pageInput      = document.getElementById('page-input');

  const buildURL = () => {
    const params = new URLSearchParams(new FormData(form));
    return `${location.pathname}?${params.toString()}`;
  };

  async function loadAjax(url){
    try{
      const resp = await fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      if (!resp.ok) return;
      const data = await resp.json();
      results.innerHTML = data.html;
      history.replaceState({}, "", url);
    }catch(err){
      console.error("Error AJAX insumos:", err);
    }
  }

  const debounce = (fn, ms = 350) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  };

  // Buscar mientras escribe
  qInput.addEventListener('input', debounce(() => {
    pageInput.value = "1";
    loadAjax(buildURL());
  }));

  // Cambios en selects
  sortSelect.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  orderSelect.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  perPageSelect.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  // Paginación y eliminar (delegación)
  results.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-ajax-link]');
    if (a){
      e.preventDefault();
      loadAjax(a.href);
      return;
    }

    const delBtn = e.target.closest('button[data-delete-insumo]');
    if (delBtn){
      const f = delBtn.closest('form');
      if (f && confirm('¿Eliminar este insumo?')){
        // submit normal, NO por AJAX (te respeta CSRF y lógica actual)
        f.submit();
      }
    }
  });
})();
</script>
{% endblock %}
