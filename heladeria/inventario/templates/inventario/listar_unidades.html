{% extends "base.html" %}
{% load static %}
{% block title %}{{ titulo|default:"Unidades de medida" }}{% endblock %}

{% block content %}
<div class="container mt-4" id="unidades-root">
  <h3 class="mb-3">{{ titulo|default:"Unidades de medida" }}</h3>

  <form id="filtros-unidades" class="row g-2 mb-3" method="get">
    <div class="col-md-4">
      <input type="text" class="form-control" name="q"
             value="{{ q|default:'' }}"
             placeholder="Buscar por nombre o código…">
    </div>

    <div class="col-md-3">
      <select class="form-select" name="sort">
        <option value="nombre" {% if sort == "nombre" %}selected{% endif %}>Nombre</option>
        <option value="codigo" {% if sort == "codigo" %}selected{% endif %}>Código</option>
      </select>
    </div>

    <div class="col-md-2">
      <select class="form-select" name="order">
        <option value="asc"  {% if order == "asc" %}selected{% endif %}>A-Z</option>
        <option value="desc" {% if order == "desc" %}selected{% endif %}>Z-A</option>
      </select>
    </div>

    <div class="col-md-2">
      <select class="form-select" name="per_page">
        <option value="5"  {% if per_page == 5 %}selected{% endif %}>5 por página</option>
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
        <option value="20" {% if per_page == 20 %}selected{% endif %}>20 por página</option>
      </select>
    </div>

    <div class="col-md-1 d-grid">
      <button class="btn btn-primary" type="submit">Aplicar</button>
    </div>
  </form>

  {% if not read_only %}
    <a href="{% url 'inventario:unidad_crear' %}" class="btn btn-success mb-3">
      ➕ Nueva Unidad
    </a>
  {% endif %}

  <div id="unidades-results">
    {% include "inventario/partials/unidad_results.html" %}
  </div>
</div>

<script>
(function(){
  const form    = document.getElementById('filtros-unidades');
  const results = document.getElementById('unidades-results');

  const qInput        = form.querySelector('input[name="q"]');
  const sortSelect    = form.querySelector('select[name="sort"]');
  const orderSelect   = form.querySelector('select[name="order"]');
  const perPageSelect = form.querySelector('select[name="per_page"]');

  const buildURL = () => {
    const params = new URLSearchParams(new FormData(form));
    return `${location.pathname}?${params.toString()}`;
  };

  async function loadAjax(url){
    const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
    if (!resp.ok) return;
    const data = await resp.json();
    results.innerHTML = data.html;
    history.replaceState({}, '', url);
  }

  const debounce = (fn, ms = 350) => {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  };

  qInput.addEventListener('input', debounce(() => loadAjax(buildURL())));
  [sortSelect, orderSelect, perPageSelect].forEach(el => {
    el.addEventListener('change', () => loadAjax(buildURL()));
  });

  results.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-ajax-link]');
    if (a){ e.preventDefault(); loadAjax(a.href); }
  });
})();
</script>
{% endblock %}
