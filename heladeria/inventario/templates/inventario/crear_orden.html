{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
    <h3 class="mb-0">{{ titulo }}</h3>

    <button type="button" id="add-row" class="btn btn-sm btn-outline-primary">
      + Agregar ítem
    </button>
  </div>

  <div class="card-body">
    <form method="post" novalidate>
      {% csrf_token %}
      {{ formset.management_form }}

      <div class="mb-4 row">
        <label for="{{ form.tipo_orden.id_for_label }}" class="col-sm-3 col-form-label fw-bold">Tipo de Operación:</label>
        <div class="col-sm-9">
          {{ form.tipo_orden }}
          {% if form.tipo_orden.errors %}
            <div class="text-danger small mt-1">{% for error in form.tipo_orden.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
          {% if form.instance.pk %}
            <small class="form-text text-muted">El tipo de orden no se puede cambiar después de su creación.</small>
            {# Esto asegura que el valor se mantenga en el POST a pesar de estar 'disabled' #}
            <input type="hidden" name="{{ form.tipo_orden.html_name }}" value="{{ form.tipo_orden.value }}">
          {% endif %}
        </div>
      </div>
      <hr>
      {% if formset.non_form_errors %}
      <div class="alert alert-danger">
        {% for error in formset.non_form_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <p class="text-muted">Completa las filas necesarias. Las filas vacías se ignorarán.</p>

      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:60%">Insumo</th>
              <th style="width:40%">Cantidad solicitada</th>
            </tr>
          </thead>

          <tbody id="formset-body">
            {% for form in formset %}
            <tr class="form-row">
              <td>
                {{ form.insumo }}
                {% for e in form.insumo.errors %}
                  <div class="text-danger small mt-1">{{ e }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.cantidad_solicitada }}
                {% for e in form.cantidad_solicitada.errors %}
                  <div class="text-danger small mt-1">{{ e }}</div>
                {% endfor %}
              </td>

              {% for hidden in form.hidden_fields %}
                {{ hidden }}
              {% endfor %}
            </tr>

            {% if form.non_field_errors %}
            <tr>
              <td colspan="2" class="text-danger small">
                {{ form.non_field_errors }}
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr>

      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'inventario:listar_ordenes' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar Orden</button>
      </div>
    </form>
  </div>
</div>

<script type="text/template" id="empty-form-template">
  <tr class="form-row">
    <td>
      {{ formset.empty_form.insumo }}
    </td>
    <td>
      {{ formset.empty_form.cantidad_solicitada }}
    </td>
    {% for hidden in formset.empty_form.hidden_fields %}
      {{ hidden }}
    {% endfor %}
  </tr>
</script>

<script>
(() => {
  const prefix = "{{ formset.prefix }}"; 
  const totalEl = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
  const tbody = document.getElementById("formset-body");
  const tpl = document.getElementById("empty-form-template").innerHTML;

  document.getElementById("add-row").addEventListener("click", () => {
    const index = parseInt(totalEl.value);

    const html = tpl.replace(/__prefix__/g, index);
    const wrapper = document.createElement("tbody");
    wrapper.innerHTML = html.trim();

    const row = wrapper.firstElementChild;

    // limpiar valores iniciales
    row.querySelectorAll("input, select").forEach(el => {
      if (el.tagName === "INPUT") el.value = "";
      if (el.tagName === "SELECT") el.selectedIndex = 0;
    });

    tbody.appendChild(row);
    totalEl.value = index + 1;
  });
})();
</script>
{% endblock %}