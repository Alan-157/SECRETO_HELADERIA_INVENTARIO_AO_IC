{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4" id="bodegas-root">
  <h3 class="mb-3">{{ titulo }}</h3>

  <form id="filtros-bodegas" class="row g-2 mb-3" method="get">
  <div class="col-md-3">
    <input type="text" class="form-control" name="q" value="{{ q|default:'' }}"
           placeholder="Buscar por nombre o dirección…">
  </div>

  <div class="col-md-3">
    <select class="form-select" name="sort">
      <option value="nombre"    {% if sort == "nombre" %}selected{% endif %}>Nombre</option>
      <option value="direccion" {% if sort == "direccion" %}selected{% endif %}>Dirección</option>
    </select>
  </div>

  {# NUEVO: dirección de orden #}
  <div class="col-md-2">
    <select class="form-select" name="order">
      <option value="asc"  {% if order == "asc" %}selected{% endif %}>A-Z</option>
      <option value="desc" {% if order == "desc" %}selected{% endif %}>Z-A</option>
    </select>
  </div>

  <div class="col-md-2">
    <select class="form-select" name="per_page">
      <option value="5"  {% if per_page == 5 %}selected{% endif %}>5 por página</option>
      <option value="10" {% if per_page == 10 %}selected{% endif %}>10 por página</option>
      <option value="20" {% if per_page == 20 %}selected{% endif %}>20 por página</option>
    </select>
  </div>

  <div class="col-md-1 d-grid">
    <button class="btn btn-primary" type="submit">Aplicar</button>
  </div>
</form>

  {% if not read_only %}
    <a href="{% url 'inventario:crear_bodega' %}" class="btn btn-success mb-3">➕ Nueva Bodega</a>
  {% endif %}

  <div id="bodegas-results">
    {% include "inventario/partials/bodegas_results.html" %}
  </div>
</div>

<script>
(function(){
  const form    = document.getElementById('filtros-bodegas');
  const results = document.getElementById('bodegas-results');

  const qInput       = form.querySelector('input[name="q"]');
  const sortSelect   = form.querySelector('select[name="sort"]');
  const orderSelect  = form.querySelector('select[name="order"]');
  const perPageSelect= form.querySelector('select[name="per_page"]');

  const buildURL = () => {
    const params = new URLSearchParams(new FormData(form));
    return `${location.pathname}?${params.toString()}`;
  };

  async function loadAjax(url){
    try {
      const resp = await fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (!resp.ok) return;
      const data = await resp.json();
      results.innerHTML = data.html;
      history.replaceState({}, '', url);
    } catch (err) {
      console.error('Error AJAX bodegas:', err);
    }
  }

  const debounce = (fn, ms = 350) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  };

  // Buscar mientras escribe
  if (qInput) {
    qInput.addEventListener('input', debounce(() => {
      loadAjax(buildURL());
    }));
  }

  // Cambiar sort / order / per_page
  [sortSelect, orderSelect, perPageSelect].forEach(el => {
    if (!el) return;
    el.addEventListener('change', () => {
      loadAjax(buildURL());
    });
  });

  // Delegación: paginación + confirmar eliminar
  results.addEventListener('click', (e) => {
    // Paginación AJAX
    const a = e.target.closest('a[data-ajax-link]');
    if (a){
      e.preventDefault();
      loadAjax(a.href);
      return;
    }

    // Eliminar bodega (submit normal, solo confirmación)
    const delBtn = e.target.closest('button[data-delete-bodega]');
    if (delBtn){
      const f = delBtn.closest('form');
      if (f && confirm('¿Eliminar esta bodega?')) {
        f.submit();
      }
    }
  });
})();
</script>
{% endblock %}
