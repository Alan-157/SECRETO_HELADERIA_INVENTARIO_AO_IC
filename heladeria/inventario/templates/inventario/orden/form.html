{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h3 class="mb-0">{{ titulo }}</h3>
    <a href="{% url 'inventario:listar_ordenes' %}" class="btn btn-outline-secondary btn-sm">
      ← Volver
    </a>
  </div>

  <div class="card-body">
    <form method="post" novalidate>
      {% csrf_token %}

      <!-- Tipo de orden -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <label class="form-label fw-semibold">Tipo de orden</label>
          {{ form_orden.tipo }}
          {% for e in form_orden.tipo.errors %}
            <div class="invalid-feedback d-block">{{ e }}</div>
          {% endfor %}
        </div>
      </div>

      {{ formset.management_form }}

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">
          {% for error in formset.non_form_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Insumo</th>
              <th style="width:120px;" class="text-end">Cantidad</th>
              <th style="width:120px;">Unidad</th>
              <th style="width:70px;"></th>
            </tr>
          </thead>

          <tbody id="formset-body">
            {% for form in formset %}
            <tr>
              <td>
                {{ form.insumo }}
                {% if form.insumo.errors %}
                  <div class="text-danger small">{{ form.insumo.errors|join:", " }}</div>
                {% endif %}
              </td>

              <td class="text-end">
                {{ form.cantidad_solicitada }}
                {% if form.cantidad_solicitada.errors %}
                  <div class="text-danger small">{{ form.cantidad_solicitada.errors|join:", " }}</div>
                {% endif %}
              </td>

              <td>
                <span class="badge bg-secondary" data-unidad>
                  {% if form.instance.pk %}
                    {{ form.instance.insumo.unidad_medida.codigo }}
                  {% endif %}
                </span>
              </td>

              <td class="text-center">
                {% if form.DELETE %}{{ form.DELETE }} <small>Eliminar</small>{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex justify-content-between">
        <button type="button" class="btn btn-outline-primary" id="add-row">
          + Agregar Ítem
        </button>

        <button type="submit" class="btn btn-success">
          Guardar Orden
        </button>
      </div>
    </form>
  </div>
</div>

<table class="d-none">
  <tbody id="empty-form-template">
    {{ formset.empty_form.as_table }}
  </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("select[name$='insumo']").forEach(select => {
        select.addEventListener("change", (e) => {
            const unidad = e.target.selectedOptions[0].dataset.unidad || "";
            const row = e.target.closest("tr");
            row.querySelector("[data-unidad]").textContent = unidad;
        });
        select.dispatchEvent(new Event("change"));
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const addBtn = document.getElementById("add-row");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");
  const tbody = document.getElementById("formset-body");
  const emptyTemplate = document.getElementById("empty-form-template").innerHTML;

  addBtn.addEventListener("click", () => {
    const idx = totalForms.value;
    const newRow = emptyTemplate.replace(/__prefix__/g, idx);
    tbody.insertAdjacentHTML("beforeend", newRow);
    totalForms.value = parseInt(idx) + 1;
  });
});
</script>
{% endblock %}
