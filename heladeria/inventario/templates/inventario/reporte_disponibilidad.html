{% extends "base.html" %}
{% load static %}
{% block title %}{{ titulo|default:"Reporte de Disponibilidad" }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12 col-xxl-10 mx-auto">

      <div class="card mb-4">
        <div class="card-body">
          <h4 class="mb-3">{{ titulo|default:"Reporte de Disponibilidad de Insumos" }}</h4>
          <p class="text-muted mb-4">Configura los filtros y columnas. Lo que ves es lo que se exporta.</p>

          <form id="filtros-form" class="row g-3" method="get" action="">
            <!-- INSUMOS -->
            <div class="col-12 col-lg-6">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Selecciona insumos</h6>
                <div class="d-flex gap-2">
                  <button id="btn-select-all" type="button" class="btn btn-sm btn-outline-primary">Seleccionar todos</button>
                  <button id="btn-clear" type="button" class="btn btn-sm btn-outline-secondary">Limpiar</button>
                </div>
              </div>

              <div class="border rounded p-2" style="max-height: 320px; overflow:auto;">
                {% if all_insumo_names %}
                  {% for nombre in all_insumo_names %}
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             value="{{ nombre }}"
                             id="insumo_{{ forloop.counter }}"
                             name="insumo"
                             {% if selected_insumos and nombre in selected_insumos %}checked{% endif %}>
                      <label class="form-check-label" for="insumo_{{ forloop.counter }}">{{ nombre }}</label>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted small">No hay insumos disponibles.</div>
                {% endif %}
              </div>
            </div>

            <!-- COLUMNAS -->
            <div class="col-12 col-lg-6">
              <h6 class="mb-2">Columnas</h6>
              <div class="row row-cols-1 row-cols-sm-2 g-2">
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show_stock_total" name="show_stock_total"
                           {% if show_stock_total %}checked{% endif %}>
                    <label class="form-check-label" for="show_stock_total">Stock total</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show_precio_unitario" name="show_precio_unitario"
                           {% if show_precio_unitario %}checked{% endif %}>
                    <label class="form-check-label" for="show_precio_unitario">Precio unitario</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show_prox_venc" name="show_prox_venc"
                           {% if show_prox_venc %}checked{% endif %}>
                    <label class="form-check-label" for="show_prox_venc">Próx. vencimiento</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show_lotes" name="show_lotes"
                           {% if show_lotes %}checked{% endif %}>
                    <label class="form-check-label" for="show_lotes">Lotes</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show_categorias" name="show_categorias"
                           {% if show_categorias %}checked{% endif %}>
                    <label class="form-check-label" for="show_categorias">Categoría</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="show_precio_acum" name="show_precio_acum"
                           {% if show_precio_acum %}checked{% endif %}>
                    <label class="form-check-label" for="show_precio_acum">Precio acumulado</label>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary">Aplicar filtros</button>
                <a href="{{ request.path }}" class="btn btn-outline-secondary">Restablecer</a>
              </div>

              <!-- EXPORTAR -->
              <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-outline-secondary export-btn" data-format="csv">⬇️ CSV</button>
                <button type="button" class="btn btn-outline-success export-btn" data-format="xlsx">⬇️ Excel</button>
                <button type="button" class="btn btn-outline-danger export-btn" data-format="pdf">⬇️ PDF</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- TABLA -->
      <div class="card">
        <div class="card-body">
          {% if categorias and categorias|length %}
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    {% if show_categorias %}<th>Categoría</th>{% endif %}
                    <th>Insumo</th>
                    <th>Unidad</th>
                    {% if show_precio_unitario %}<th class="text-end">Precio unit.</th>{% endif %}
                    {% if show_stock_total %}<th class="text-end">Stock total</th>{% endif %}
                    {% if show_prox_venc %}<th>Próx. venc.</th>{% endif %}
                    {% if show_precio_acum %}<th class="text-end">Precio acumulado</th>{% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for bloque in categorias %}
                    {% for i in bloque.insumos %}
                      <tr>
                        {% if show_categorias %}<td>{{ bloque.categoria.nombre }}</td>{% endif %}
                        <td>{{ i.nombre }}</td>
                        <td>{{ i.unidad_medida }}</td>
                        {% if show_precio_unitario %}
                          <td class="text-end">{{ i.precio_unitario|default:0|floatformat:2 }}</td>
                        {% endif %}
                        {% if show_stock_total %}
                          <td class="text-end">{{ i.stock_total|default:0|floatformat:2 }}</td>
                        {% endif %}
                        {% if show_prox_venc %}
                          <td>{% if i.prox_vencimiento %}{{ i.prox_vencimiento|date:"d-m-Y" }}{% else %}-{% endif %}</td>
                        {% endif %}
                        {% if show_precio_acum %}
                          <td class="text-end">{{ i.precio_acumulado|default:0|floatformat:2 }}</td>
                        {% endif %}
                      </tr>

                      {% if show_lotes and i.lotes_vis %}
                        <tr class="bg-body-tertiary">
                          <td colspan="{{ colspan_lotes }}">
                            <div class="p-2">
                              <div class="fw-semibold mb-1">Lotes</div>
                              <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                  <thead>
                                    <tr>
                                      <th>ID</th>
                                      <th>Ingreso</th>
                                      <th>Venc.</th>
                                      <th class="text-end">Cantidad</th>
                                      <th>Bodega</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for lote in i.lotes_vis %}
                                      <tr>
                                        <td>{{ lote.id }}</td>
                                        <td>{% if lote.fecha_ingreso %}{{ lote.fecha_ingreso|date:"d-m-Y" }}{% else %}-{% endif %}</td>
                                        <td>{% if lote.fecha_expiracion %}{{ lote.fecha_expiracion|date:"d-m-Y" }}{% else %}-{% endif %}</td>
                                        <td class="text-end">{{ lote.cantidad_actual|default:0|floatformat:2 }}</td>
                                        <td>{{ lote.bodega.nombre }}</td>
                                      </tr>
                                    {% endfor %}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr class="fw-semibold">
                    {% if show_categorias %}<td></td>{% endif %}
                    <td colspan="2">Totales</td>
                    {% if show_precio_unitario %}<td></td>{% endif %}
                    {% if show_stock_total %}<td class="text-end">{{ total_stock|default:0|floatformat:2 }}</td>{% endif %}
                    {% if show_prox_venc %}<td></td>{% endif %}
                    {% if show_precio_acum %}<td class="text-end">{{ total_valor|default:0|floatformat:2 }}</td>{% endif %}
                  </tr>
                </tfoot>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-4">No hay resultados con los filtros seleccionados.</div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('filtros-form');
  const btnAll = document.getElementById('btn-select-all');
  const btnClear = document.getElementById('btn-clear');
  const exportBtns = document.querySelectorAll('.export-btn');

  btnAll?.addEventListener('click', ()=>{
    form.querySelectorAll('input[name="insumo"]').forEach(chk => chk.checked = true);
  });

  btnClear?.addEventListener('click', ()=>{
    form.querySelectorAll('input[name="insumo"]').forEach(chk => chk.checked = false);
  });

  // Exporta respetando filtros actuales y SIN duplicar "format"
  exportBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const fd = new FormData(form);
      fd.delete('format');
      const params = new URLSearchParams();
      for (const [k, v] of fd.entries()) {
        if (v !== null && v !== '') params.append(k, v);
      }
      params.append('format', btn.dataset.format);
      window.location.href = `${location.pathname}?${params.toString()}`;
    });
  });
})();
</script>
{% endblock %}
