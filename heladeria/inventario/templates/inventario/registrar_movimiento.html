{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <h3 class="mb-0">{{ titulo }}</h3>
    <button id="add-line" type="button" class="btn btn-sm btn-outline-primary">+ Agregar ítem</button>
  </div>

  <div class="card-body">
    <form method="post" novalidate>
      {% if orden %}
        <input type="hidden" name="orden_id" value="{{ orden.id }}">
      {% endif %}
      {% csrf_token %}
      {{ formset.management_form }}

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th style="min-width:120px;">Tipo</th>
              <th>Insumo</th>
              <th style="min-width:160px;">Lote existente</th>
              <th style="min-width:120px;">Nuevo lote</th>
              <th style="min-width:160px;">Expiración</th>
              <th>Ubicación</th>
              <th style="min-width:120px;">Cantidad</th>
              <th style="min-width:140px;">Fecha</th>
              <th>Obs.</th>
              <th style="width:40px;"></th>
            </tr>
          </thead>
          <tbody id="formset-body">
            {% for f in formset %}
            <tr class="fs-row">
              <td>{{ f.tipo }}</td>
              <td>{{ f.insumo }}</td>
              <td>{{ f.insumo_lote }}</td>
              <td>{{ f.crear_nuevo_lote }}</td>
              <td>{{ f.fecha_expiracion }}</td>
              <td>{{ f.ubicacion }}</td>
              <td>{{ f.cantidad }}</td>
              <td>{{ f.fecha }}</td>
              <td>{{ f.observaciones }}</td>
              <td>
                {% if formset.can_delete %}
                  {{ f.DELETE }} <button type="button" class="btn btn-sm btn-outline-danger del-line">×</button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}

      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'inventario:listar_movimientos' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Template oculto del empty_form (con __prefix__) -->
<script type="text/template" id="empty-form-row">
  <tr class="fs-row">
    <td>{{ formset.empty_form.tipo }}</td>
    <td>{{ formset.empty_form.insumo }}</td>
    <td>{{ formset.empty_form.insumo_lote }}</td>
    <td>{{ formset.empty_form.crear_nuevo_lote }}</td>
    <td>{{ formset.empty_form.fecha_expiracion }}</td>
    <td>{{ formset.empty_form.ubicacion }}</td>
    <td>{{ formset.empty_form.cantidad }}</td>
    <td>{{ formset.empty_form.fecha }}</td>
    <td>{{ formset.empty_form.observaciones }}</td>
    <td>
      {% if formset.can_delete %}
        {{ formset.empty_form.DELETE }}
        <button type="button" class="btn btn-sm btn-outline-danger del-line">×</button>
      {% endif %}
    </td>
  </tr>
</script>

<script>
(function(){
  const tbody = document.getElementById("formset-body");
  const addBtn = document.getElementById("add-line");
  const total = document.getElementById("id_form-TOTAL_FORMS");
  const rawTpl = document.getElementById("empty-form-row").textContent;

  addBtn.addEventListener("click", function(){
    const index = parseInt(total.value, 10);
    const html = rawTpl.replace(/__prefix__/g, index);

    const tmp = document.createElement("tbody");
    tmp.innerHTML = html.trim();
    const tr = tmp.firstElementChild; // ya es <tr class="fs-row"> … </tr>

    tbody.appendChild(tr);
    total.value = index + 1;
  });

  tbody.addEventListener("click", function(e){
    if (e.target.classList.contains("del-line")){
      const tr = e.target.closest("tr");
      const del = tr.querySelector('input[name$="-DELETE"]');
      if (del) del.checked = true;
      tr.style.display = "none";
    }
  });
})();
</script>
<style>
  input[name$="-DELETE"] {
    display: none;
  }
</style>
{% endblock %}
