{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <h3 class="mb-0">{{ titulo }}</h3>
    <button id="add-line" type="button" class="btn btn-sm btn-outline-primary">+ Agregar Ã­tem</button>
  </div>

  <div class="card-body">
    <form method="post" novalidate id="mov-form">
      {% csrf_token %}
      {{ formset.management_form }}

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}

      <div id="lines" class="d-flex flex-column gap-3">
        {% for f in formset.forms %}
        <div class="border rounded-3 p-3 movimiento-line bg-light-subtle" data-prefix="{{ f.prefix }}">

          {# DELETE hidden (NO mostrar checkbox) #}
          {% if f.DELETE %}
            <div style="display:none">{{ f.DELETE }}</div>
          {% endif %}
          {% if orden %}
          <div class="alert alert-info">
              Atendiendo Orden #{{ orden.id }} creada por {{ orden.usuario.name }}.
          </div>
          {% endif %}
          <!-- FILA 1: Tipo / Insumo Buscador / Bodega / UbicaciÃ³n / Lote / X -->
          <div class="row g-3 align-items-end">

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">Tipo</label>
              {{ f.tipo }}
              {% for e in f.tipo.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <div class="col-lg-4 col-md-6 position-relative">
              <label class="form-label fw-semibold">Insumo</label>

              {# select real oculto #}
              <div class="d-none">
                {{ f.insumo }}
              </div>

              {# input buscador visible #}
              <input type="text"
                     class="form-control js-insumo-search"
                     placeholder="Escribe para buscar insumo..."
                     autocomplete="off"
                     disabled>

              <input type="hidden" class="js-insumo-id">

              {# dropdown resultados #}
              <div class="dropdown-menu w-100 p-2 shadow js-insumo-dd" style="max-height:260px; overflow:auto;">
                <div class="js-insumo-results small"></div>
                <div class="d-flex justify-content-between align-items-center pt-2 border-top mt-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary js-insumo-prev">Â«</button>
                  <span class="small text-muted js-insumo-page">1/1</span>
                  <button type="button" class="btn btn-sm btn-outline-secondary js-insumo-next">Â»</button>
                </div>
              </div>

              {% for e in f.insumo.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">Bodega</label>
              {{ f.bodega }}
              {% for e in f.bodega.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">UbicaciÃ³n</label>
              {{ f.ubicacion }}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">Lote existente</label>
              {{ f.insumo_lote }}
              {% for e in f.insumo_lote.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <!-- BotÃ³n X SIEMPRE a la derecha -->
            <div class="col-lg-0 col-md-0 ms-auto text-end">
              <button type="button"
                      class="btn btn-outline-danger btn-sm js-remove"
                      title="Eliminar lÃ­nea">âœ•</button>
            </div>
          </div>

          <!-- FILA 2: Nuevo lote / ExpiraciÃ³n / Cantidad / Fecha / Obs -->
          <div class="row g-3 align-items-end mt-1">

            <div class="col-lg-2 col-md-3 d-flex align-items-center gap-2">
              <div class="form-check mt-4">
                {{ f.crear_nuevo_lote }}
                <label class="form-check-label">Nuevo lote</label>
              </div>
              {% for e in f.crear_nuevo_lote.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">ExpiraciÃ³n</label>
              {{ f.fecha_expiracion }}
              {% for e in f.fecha_expiracion.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">Cantidad</label>
              {{ f.cantidad }}
              <small class="text-muted d-block js-maxhint"></small>
              {% for e in f.cantidad.errors %}<div class="invalid-feedback d-block">{{e}}</div>{% endfor %}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label fw-semibold">Fecha ingreso</label>
              {{ f.fecha }}
            </div>

            <div class="col-lg-4 col-md-12">
              <label class="form-label fw-semibold">Observaciones</label>
              {{ f.observaciones }}
            </div>

          </div>

        </div>
        {% endfor %}
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <a href="{% url 'inventario:listar_movimientos' %}" class="btn btn-secondary">Cancelar</a>
        <button class="btn btn-primary" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if orden %}
<script>
document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll(".movimiento-line select[name$='-tipo']").forEach(s=>{
        s.value = "SALIDA";
        s.setAttribute("disabled","disabled");
    });
});
</script>
{% endif %}

<script>
(function(){
  const lines = document.getElementById("lines");

  function qs(prefix, name){
    return document.querySelector(`[name="${prefix}-${name}"]`);
  }
  function enable(el){ if(el){ el.removeAttribute("disabled"); } }
  function disable(el){ if(el){ el.setAttribute("disabled","disabled"); } }

  async function fetchJSON(url){
    const r = await fetch(url, {headers: {"X-Requested-With":"XMLHttpRequest"}});
    return await r.json();
  }

  // =====================================================
  //        ðŸ”µ  FILTRAR LOTES POR INSUMO / BODEGA
  // =====================================================
  async function updateLotes(prefix){
    const insumo = qs(prefix,"insumo");
    const bodega = qs(prefix,"bodega");
    const loteSel = qs(prefix,"insumo_lote");
    if(!loteSel) return;

    const insumoId = insumo?.value || "";
    const bodegaId = bodega?.value || "";

    let url = `{% url 'inventario:ajax_lotes_por_insumo' %}?`;
    if(insumoId) url += `insumo_id=${insumoId}&`;
    if(bodegaId) url += `bodega_id=${bodegaId}`;

    const data = await fetchJSON(url);

    loteSel.innerHTML = `<option value="">---------</option>`;

    if(data.ok){
      data.lotes.forEach(l=>{
        const opt = document.createElement("option");
        opt.value = l.id;
        opt.textContent = l.text;
        loteSel.appendChild(opt);
      });
    }
  }

  // =====================================================
  //                ðŸ”µ BUSCADOR INSUMOS AJAX
  // =====================================================
  async function loadInsumos(line, qText="", page=1){
    const dd = line.querySelector(".js-insumo-dd");
    const resultsBox = line.querySelector(".js-insumo-results");
    const pageLbl = line.querySelector(".js-insumo-page");
    const prevBtn = line.querySelector(".js-insumo-prev");
    const nextBtn = line.querySelector(".js-insumo-next");

    line.dataset.insPage = page;
    line.dataset.insQuery = qText;

    const url = `{% url 'inventario:ajax_insumos' %}?q=${encodeURIComponent(qText)}&page=${page}&per_page=5`;
    const data = await fetchJSON(url);

    resultsBox.innerHTML = "";
    if(!data.ok || data.results.length===0){
      resultsBox.innerHTML = `<div class="text-muted px-2 py-1">Sin resultadosâ€¦</div>`;
    }else{
      data.results.forEach(it=>{
        const btn = document.createElement("button");
        btn.type="button";
        btn.className="dropdown-item";
        btn.textContent=it.text;
        btn.dataset.id=it.id;
        btn.dataset.text=it.text;
        resultsBox.appendChild(btn);
      });
    }

    pageLbl.textContent = `${data.page}/${data.num_pages}`;
    prevBtn.disabled = !data.has_prev;
    nextBtn.disabled = !data.has_next;

    dd.classList.add("show");
  }

  function closeAllDropdowns(){
    document.querySelectorAll(".js-insumo-dd.show").forEach(d=>d.classList.remove("show"));
  }

  // =====================================================
  //              ðŸ”µ CLICK HANDLER GENERAL
  // =====================================================
  lines.addEventListener("click", async (e)=>{
    const line = e.target.closest(".movimiento-line");
    if(!line) return;

    // abrir lista al click
    if(e.target.classList.contains("js-insumo-search")){
      const value = e.target.value.trim();
      await loadInsumos(line, value, 1);
      return;
    }

    // -----------------------------------------------------
    // ðŸ”µ SELECCIONAR INSUMO (AQUÃ SE AGREGA updateLotes())
    // -----------------------------------------------------
    if(e.target.classList.contains("dropdown-item")){
      const prefix = line.dataset.prefix;
      const realSelect = qs(prefix,"insumo");
      const searchInput = line.querySelector(".js-insumo-search");

      realSelect.value = e.target.dataset.id;
      realSelect.dispatchEvent(new Event("change"));
      searchInput.value = e.target.dataset.text;

      // ðŸ”“ desbloquear siguientes campos
      enable(qs(prefix,"bodega"));
      enable(qs(prefix,"insumo_lote"));
      enable(qs(prefix,"cantidad"));

      // ðŸŸ¦ FILTRAR LOTES TRAS ELEGIR INSUMO
      await updateLotes(prefix);

      closeAllDropdowns();
      return;
    }

    // paginar en dropdown
    if(e.target.classList.contains("js-insumo-prev") || e.target.classList.contains("js-insumo-next")){
      const qText = line.dataset.insQuery || "";
      let page = parseInt(line.dataset.insPage || "1");
      page += e.target.classList.contains("js-insumo-next") ? 1 : -1;
      await loadInsumos(line, qText, page);
      return;
    }

    // eliminar lÃ­nea
    if(e.target.classList.contains("js-remove")){
      const del = line.querySelector(`input[type="checkbox"][name$="-DELETE"]`);
      if(del){
        del.checked = true;
        line.style.display = "none";
      }else{
        line.remove();
      }
      return;
    }
  });

  // =====================================================
  //            ðŸ”µ INPUT: filtrar mientras escribe
  // =====================================================
  lines.addEventListener("input", async (e)=>{
    const line = e.target.closest(".movimiento-line");
    if(!line) return;

    if(e.target.classList.contains("js-insumo-search")){
      await loadInsumos(line, e.target.value.trim(), 1);
    }
  });

  // =====================================================
  //            ðŸ”µ focus: abrir dropdown vacÃ­o
  // =====================================================
  lines.addEventListener("focusin", async (e)=>{
    const line = e.target.closest(".movimiento-line");
    if(!line) return;

    if(e.target.classList.contains("js-insumo-search")){
      await loadInsumos(line, e.target.value.trim(), 1);
    }
  });

  // cerrar dropdowns
  document.addEventListener("click",(e)=>{
    if(!e.target.closest(".js-insumo-search") && !e.target.closest(".js-insumo-dd")){
      closeAllDropdowns();
    }
  });

  // =====================================================
  //              ðŸ”µ BLOQUEOS POR TIPO
  // =====================================================
  function lockByTipo(prefix){
    const tipo = qs(prefix,"tipo").value;
    const insumo = qs(prefix,"insumo");
    const bodega = qs(prefix,"bodega");
    const lote = qs(prefix,"insumo_lote");
    const nuevo = qs(prefix,"crear_nuevo_lote");
    const exp = qs(prefix,"fecha_expiracion");
    const cantidad = qs(prefix,"cantidad");
    const fecha = qs(prefix,"fecha");
    const obs = qs(prefix,"observaciones");

    const searchInput = document.querySelector(`.movimiento-line[data-prefix="${prefix}"] .js-insumo-search`);

    disable(insumo); disable(bodega); disable(lote); disable(nuevo);
    disable(exp); disable(cantidad); disable(fecha); disable(obs);
    disable(searchInput);

    if(fecha){ fecha.valueAsDate = new Date(); }

    if(tipo){
      enable(searchInput);
      enable(fecha);
      enable(obs);

      if(insumo.value){
        enable(insumo);
        enable(bodega);
        enable(lote);
        enable(cantidad);
      } else {
        enable(insumo);
      }
    }

    if(tipo==="SALIDA"){
      enable(lote);
      disable(nuevo);
      disable(exp);
      disable(bodega);
      disable(insumo);
      disable(searchInput);
      enable(cantidad);
    }
  }

  // =====================================================
  //        ðŸ”µ Cuando cambia tipo o bodega
  // =====================================================
  lines.addEventListener("change", async (e)=>{
    const line = e.target.closest(".movimiento-line");
    if(!line) return;
    const prefix = line.dataset.prefix;

    if(e.target.classList.contains("js-tipo")){
      lockByTipo(prefix);
    }

    // ðŸ”µ si cambia bodega, volver a filtrar lotes
    if(e.target.classList.contains("js-bodega")){
      await updateLotes(prefix);
    }
  });

  // init bloqueos
  document.querySelectorAll(".movimiento-line").forEach(line=>{
    lockByTipo(line.dataset.prefix);
  });

})();
</script>

{% endblock %}
