{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <h3 class="mb-0">{{ titulo }}</h3>
        <button id="add-line" type="button" class="btn btn-sm btn-outline-primary">+ Agregar ítem</button>
    </div>

    <div class="card-body">
        
        {% if orden %}
            <div class="alert alert-info">
                Registrando movimientos para la **Orden #{{ orden.id }}** (Estado: {{ orden.estado }}).
            </div>
        {% endif %}

        <form method="post" novalidate>
            {% if orden %}
                <input type="hidden" name="orden_id" value="{{ orden.id }}">
            {% endif %}
            {% csrf_token %}
            {{ formset.management_form }}
            
            {# MUESTRA ERRORES GLOBALES DEL FORMSET (NO DE LÍNEA) #}
            {% if formset.non_form_errors %}
                <div class="alert alert-danger">
                    <strong>Errores Generales:</strong>
                    <ul>
                        {% for error in formset.non_form_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="min-width:120px;">Tipo</th>
                            <th>Insumo</th>
                            <th style="min-width:160px;">Lote existente</th>
                            <th style="min-width:120px;">Nuevo lote</th>
                            <th style="min-width:160px;">Expiración</th>
                            <th>Ubicación</th>
                            <th style="min-width:120px;">Cantidad</th>
                            <th style="min-width:140px;">Fecha</th>
                            <th>Obs.</th>
                            <th style="width:40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="formset-body">
                        {% for f in formset %}
                        <tr class="fs-row {% if f.errors %}table-danger{% endif %}">
                            {# TIPO #}
                            <td>
                                {{ f.tipo }}
                                {% for error in f.tipo.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# INSUMO #}
                            <td>
                                {{ f.insumo }}
                                {% for error in f.insumo.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# LOTE EXISTENTE #}
                            <td>
                                {{ f.insumo_lote }}
                                {% for error in f.insumo_lote.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# CREAR NUEVO LOTE #}
                            <td>
                                <div class="form-check">
                                    {{ f.crear_nuevo_lote }}
                                    <label class="form-check-label">{{ f.crear_nuevo_lote.label }}</label>
                                </div>
                                {% for error in f.crear_nuevo_lote.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# FECHA EXPIRACIÓN #}
                            <td>
                                {{ f.fecha_expiracion }}
                                {% for error in f.fecha_expiracion.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# UBICACIÓN #}
                            <td>
                                {{ f.ubicacion }}
                                {% for error in f.ubicacion.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# CANTIDAD #}
                            <td>
                                {{ f.cantidad }}
                                {% for error in f.cantidad.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# FECHA #}
                            <td>
                                {{ f.fecha }}
                                {% for error in f.fecha.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# OBSERVACIONES #}
                            <td>
                                {{ f.observaciones }}
                                {% for error in f.observaciones.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                            </td>
                            {# BOTÓN ELIMINAR #}
                            <td>
                                {{ f.id }} {# Campo ID oculto #}
                                {% if formset.can_delete %}
                                    {{ f.DELETE }} <button type="button" class="btn btn-sm btn-outline-danger del-line">×</button>
                                {% endif %}
                                {# Campos ocultos extra #}
                                {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}
                            </td>
                        </tr>
                        {# MUESTRA ERRORES A NIVEL DE LÍNEA (non_field_errors) #}
                        {% if f.non_field_errors %}
                            <tr class="table-danger"><td colspan="10">
                                <div class="text-danger small">
                                    <strong>Error en la línea:</strong> {{ f.non_field_errors|join:", " }}
                                </div>
                            </td></tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a href="{% url 'inventario:listar_movimientos' %}" class="btn btn-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script type="text/template" id="empty-form-row">
    <tr class="fs-row">
        {# TIPO #}
        <td>
            {{ formset.empty_form.tipo }}
        </td>
        {# INSUMO #}
        <td>
            {{ formset.empty_form.insumo }}
        </td>
        {# LOTE EXISTENTE #}
        <td>
            {{ formset.empty_form.insumo_lote }}
        </td>
        {# CREAR NUEVO LOTE #}
        <td>
            <div class="form-check">
                {{ formset.empty_form.crear_nuevo_lote }}
                <label class="form-check-label">{{ formset.empty_form.crear_nuevo_lote.label }}</label>
            </div>
        </td>
        {# FECHA EXPIRACIÓN #}
        <td>
            {{ formset.empty_form.fecha_expiracion }}
        </td>
        {# UBICACIÓN #}
        <td>
            {{ formset.empty_form.ubicacion }}
        </td>
        {# CANTIDAD #}
        <td>
            {{ formset.empty_form.cantidad }}
        </td>
        {# FECHA #}
        <td>
            {{ formset.empty_form.fecha }}
        </td>
        {# OBSERVACIONES #}
        <td>
            {{ formset.empty_form.observaciones }}
        </td>
        {# BOTÓN ELIMINAR #}
        <td>
            {{ formset.empty_form.id }}
            {% if formset.can_delete %}
                {{ formset.empty_form.DELETE }}
                <button type="button" class="btn btn-sm btn-outline-danger del-line">×</button>
            {% endif %}
            {# Campos ocultos extra #}
            {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
        </td>
    </tr>
</script>

<script>
// Lógica de JavaScript para añadir y eliminar líneas del formset
(function(){
    const tbody = document.getElementById("formset-body");
    const addBtn = document.getElementById("add-line");
    const total = document.getElementById("id_form-TOTAL_FORMS");
    const rawTpl = document.getElementById("empty-form-row").textContent;

    addBtn.addEventListener("click", function(){
        const index = parseInt(total.value, 10);
        const html = rawTpl.replace(/__prefix__/g, index);

        // Usar Range.createContextualFragment para parseo eficiente
        const range = document.createRange();
        range.selectNode(document.body);
        const fragment = range.createContextualFragment(html.trim());
        const tr = fragment.querySelector('tr');

        tbody.appendChild(tr);
        total.value = index + 1;
        
        // Opcional: Re-inicializar select2, datepickers, etc., si se usan.
        // e.g., initDatepickers(tr);
    });

    tbody.addEventListener("click", function(e){
        if (e.target.classList.contains("del-line")){
            const tr = e.target.closest("tr");
            const del = tr.querySelector('input[name$="-DELETE"]');
            if (del) del.checked = true;
            tr.style.display = "none";
        }
    });
})();
</script>
<style>
    /* Oculta el checkbox de DELETE */
    input[name$="-DELETE"] {
        display: none;
    }
</style>
{% endblock %}