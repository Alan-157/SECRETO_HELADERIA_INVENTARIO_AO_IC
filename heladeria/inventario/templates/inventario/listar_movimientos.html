{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {# HEADER Y BOTÓN NUEVO MOVIMIENTO (DROPDOWN) #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">{{ titulo }}</h3>

        {% if can_manage %}
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-lg"></i> Nuevo Movimiento
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item text-success" href="{% url 'inventario:registrar_entrada_movimiento' %}">
                            <i class="bi bi-box-arrow-in-down"></i> Registrar Entrada
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'inventario:registrar_salida_movimiento' %}">
                            <i class="bi bi-box-arrow-up"></i> Registrar Salida
                        </a>
                    </li>
                </ul>
            </div>
        {% endif %}
    </div>

    {# INICIO: ESTRUCTURA DE PESTAÑAS (TABS) #}
    {% comment %} 
        Usamos 'tab' en la URL para saber qué paginador cargar de forma optimizada.
        Si 'pestaña_activa' viene de la URL, la usamos. Si no, es 'entradas' por defecto.
    {% endcomment %}
    <div class="card shadow-sm">
        <div class="card-header p-0">
            <ul class="nav nav-tabs card-header-tabs" id="movimientosTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if not is_salida_active %}active{% endif %}" 
                            id="entrada-tab" data-bs-toggle="tab" data-bs-target="#entrada-pane" 
                            type="button" role="tab" aria-controls="entrada-pane" 
                            data-tab-name="entradas"
                            aria-selected="{% if not is_salida_active %}true{% else %}false{% endif %}">
                        Entradas ({{ entradas.paginator.count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if is_salida_active %}active{% endif %}" 
                            id="salida-tab" data-bs-toggle="tab" data-bs-target="#salida-pane" 
                            type="button" role="tab" aria-controls="salida-pane" 
                            data-tab-name="salidas"
                            aria-selected="{% if is_salida_active %}true{% else %}false{% endif %}">
                        Salidas ({{ salidas.paginator.count }})
                    </button>
                </li>
            </ul>
        </div>

        <div class="card-body">
            {# Formulario de Búsqueda Mejorado #}
            <form method="get" class="mb-3" id="search-form">
                <div class="row g-2">
                    {# Filtro por Insumo con Select2 AJAX #}
                    <div class="col-md-4">
                        <label class="form-label small mb-1">Filtrar por Insumo</label>
                        <select name="insumo_id" id="insumo-filter" class="form-select">
                            {% if insumo_seleccionado %}
                                <option value="{{ insumo_seleccionado.id }}" selected>
                                    {{ insumo_seleccionado.nombre }} ({{ insumo_seleccionado.categoria.nombre|default:"Sin categoría" }})
                                </option>
                            {% else %}
                                <option value="">Todos los insumos</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    {# Búsqueda por texto #}
                    <div class="col-md-5">
                        <label class="form-label small mb-1">Búsqueda general</label>
                        <input type="text" name="q" class="form-control" placeholder="Buscar por ubicación u observación..." value="{{ q|default:'' }}">
                    </div>
                    
                    {# Items por página #}
                    <div class="col-md-2">
                        <label class="form-label small mb-1">Mostrar</label>
                        <select name="per_page" class="form-select">
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        </select>
                    </div>
                    
                    {# Botones #}
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-primary w-100" type="submit" title="Aplicar filtros">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                
                {# Botón limpiar filtros #}
                {% if q or insumo_id %}
                <div class="mt-2">
                    <a href="{% url 'inventario:listar_movimientos' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Limpiar filtros
                    </a>
                </div>
                {% endif %}
                
                {# Campo oculto para mantener la pestaña activa durante la búsqueda #}
                <input type="hidden" name="tab" id="active-tab-input" value="{{ pestaña_activa }}">
            </form>

            <div class="tab-content" id="movimientosTabContent">
                
                {# PESTAÑA 1: ENTRADAS #}
                <div class="tab-pane fade {% if not is_salida_active %}show active{% endif %}" 
                     id="entrada-pane" role="tabpanel" aria-labelledby="entrada-tab" tabindex="0">
                    <div id="entradas-results">
                        {% include "inventario/partials/entradas_table.html" with movimientos=entradas q=q page_param="page_e" %}
                    </div>
                </div>

                {# PESTAÑA 2: SALIDAS (Contenido solo visible si está activo o cargado por JS) #}
                <div class="tab-pane fade {% if is_salida_active %}show active{% endif %}" 
                     id="salida-pane" role="tabpanel" aria-labelledby="salida-tab" tabindex="0">
                    <div id="salidas-results">
                        {% include "inventario/partials/salidas_table.html" with movimientos=salidas q=q page_param="page_s" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {# FIN: ESTRUCTURA DE PESTAÑAS (TABS) #}

</div>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlBase = "{% url 'inventario:listar_movimientos' %}";
        const apiEntradas = "{% url 'inventario:api_movimientos_entradas' %}";
        const apiSalidas = "{% url 'inventario:api_movimientos_salidas' %}";
        const movimientosTab = document.getElementById('movimientosTab');
        const activeTabInput = document.getElementById('active-tab-input');
        const perPageSelect = document.querySelector('select[name="per_page"]');
        const tabEntradasBtn = document.getElementById('entrada-tab');
        const tabSalidasBtn = document.getElementById('salida-tab');
        
        let currentTab = activeTabInput.value || 'entradas';

                // --- Helpers de tabla ---
                function ensureTable(tabName) {
                        const targetDiv = document.getElementById(tabName + '-results');
                        const selector = tabName === 'entradas' ? '#entradas-results table' : '#salidas-results table';
                        let table = document.querySelector(selector);
                        if (table) return table;

                        // Si no existe (porque se limpió el innerHTML), creamos la estructura básica
                        const markup = (tabName === 'entradas') ? `
                                <table class="table table-striped table-bordered table-sm mb-3">
                                    <thead class="table-success">
                                        <tr>
                                            <th style="width: 10%;">Fecha</th>
                                            <th>Insumo</th>
                                            <th style="width: 8%;">Cantidad</th>
                                            <th style="width: 12%;">Ubicación</th>
                                            <th style="width: 12%;">Fecha Exp.</th>
                                            <th style="width: 18%;">Usuario</th>
                                            <th style="width: 20%;" class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>`
                        : `
                                <table class="table table-striped table-bordered table-sm mb-3">
                                    <thead class="table-danger">
                                        <tr>
                                            <th style="width: 10%;">Fecha Salida</th>
                                            <th>Insumo</th>
                                            <th style="width: 8%;">Cantidad</th>
                                            <th style="width: 12%;">Ubicación</th>
                                            <th style="width: 12%;">Lote Origen</th>
                                            <th style="width: 18%;">Tipo</th>
                                            <th style="width: 18%;">Usuario</th>
                                            <th style="width: 15%;" class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>`;
                        targetDiv.innerHTML = markup;
                        table = targetDiv.querySelector('table');
                        return table;
                }

                // Render helpers (cliente) para filas
        function renderEntradasRows(items) {
            return items.map(e => `
                <tr>
                  <td>${formatDate(e.fecha)}</td>
                  <td>${escapeHtml(e.insumo)}</td>
                  <td>${formatNumber(e.cantidad)}</td>
                  <td>${escapeHtml(e.ubicacion)}</td>
                  <td>${e.fecha_expiracion ? formatDate(e.fecha_expiracion) : '—'}</td>
                  <td>${escapeHtml(e.usuario || '—')}</td>
                  <td class="text-center">
                    {% if can_manage %}
                    <div class="d-flex justify-content-center gap-1">
                        <a href="{% url 'inventario:editar_entrada' 0 %}" class="btn btn-sm btn-outline-warning" title="Editar Entrada" onclick="event.preventDefault(); location.href=this.href.replace('/0/','/${e.id}/');"><i class="bi bi-pencil"></i> Editar</a>
                        <form method="post" action="{% url 'inventario:eliminar_entrada' 0 %}" class="d-inline delete-form-entrada" data-entry-id="${e.id}"> 
                          {% csrf_token %}
                          <button type="button" class="btn btn-sm btn-outline-danger" data-confirm-delete="true" data-objeto-nombre="Entrada #${e.id}" data-objeto-tipo="entrada" title="Eliminar Entrada"><i class="bi bi-trash"></i> Eliminar</button>
                        </form>
                    </div>
                    {% endif %}
                  </td>
                </tr>
            `).join('');
        }

        function renderSalidasRows(items) {
            return items.map(s => `
                <tr>
                  <td>${formatDate(s.fecha_generada)}</td>
                  <td>${escapeHtml(s.insumo)}</td>
                  <td>${formatNumber(s.cantidad)}</td>
                  <td>${escapeHtml(s.ubicacion)}</td>
                  <td>${s.lote_id ? `<span class="badge bg-secondary">#${s.lote_id}</span>` : '—'}</td>
                  <td>${escapeHtml(s.tipo)}</td>
                  <td>${escapeHtml(s.usuario || '—')}</td>
                  <td class="text-center">
                    {% if can_manage %}
                    <div class="d-flex justify-content-center gap-1">
                        <a href="{% url 'inventario:editar_salida' 0 %}" class="btn btn-sm btn-outline-warning" title="Editar Salida" onclick="event.preventDefault(); location.href=this.href.replace('/0/','/${s.id}/');"><i class="bi bi-pencil"></i> Editar</a>
                        <form method="post" action="{% url 'inventario:eliminar_salida' 0 %}" class="d-inline delete-form-salida" data-entry-id="${s.id}"> 
                          {% csrf_token %}
                          <button type="button" class="btn btn-sm btn-outline-danger" data-confirm-delete="true" data-objeto-nombre="Salida #${s.id}" data-objeto-tipo="salida" title="Eliminar Salida"><i class="bi bi-trash"></i> Eliminar</button>
                        </form>
                    </div>
                    {% endif %}
                  </td>
                </tr>
            `).join('');
        }

        function renderTable(tabName, json) {
            const targetDiv = document.getElementById(tabName + '-results');
            const table = ensureTable(tabName);
            const rows = (tabName === 'entradas') ? renderEntradasRows(json.results) : renderSalidasRows(json.results);
            const tbody = table.querySelector('tbody');
            if (tbody) tbody.innerHTML = rows || `<tr><td colspan="8" class="text-center text-muted py-3">No hay ${tabName} registradas.</td></tr>`;
            // Render paginación simple
            const pagDiv = targetDiv.querySelector('.pagination') || document.createElement('div');
            const pageParam = tabName === 'entradas' ? 'page_e' : 'page_s';
            pagDiv.className = 'd-flex justify-content-center mt-2';
            pagDiv.innerHTML = `
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item ${json.page <= 1 ? 'disabled':''}">
                    <a class="page-link" href="#" data-page="${json.page - 1}" data-param="${pageParam}">«</a>
                  </li>
                  <li class="page-item active"><span class="page-link">${json.page}/${json.pages}</span></li>
                  <li class="page-item ${json.page >= json.pages ? 'disabled':''}">
                    <a class="page-link" href="#" data-page="${json.page + 1}" data-param="${pageParam}">»</a>
                  </li>
                </ul>`;
            targetDiv.appendChild(pagDiv);
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text ?? '').replace(/[&<>"']/g, m => map[m]);
        }
        function formatDate(iso) {
            if (!iso) return '—';
            const d = new Date(iso);
            return d.toLocaleDateString();
        }
        function formatNumber(n) { return Number(n ?? 0).toLocaleString('es-CL'); }

        // --- FUNCIÓN CENTRAL: cargar desde API JSON ---
        function loadContent(tabName, paramsObj) {
            currentTab = tabName;
            activeTabInput.value = tabName;
            const targetDiv = document.getElementById(tabName + '-results');
            const table = ensureTable(tabName);
            const tbody = table.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">Cargando movimientos, por favor espere...</td></tr>';
            }

            const q = document.querySelector('[name="q"]').value;
            const perPage = perPageSelect ? perPageSelect.value : '20';

            const url = tabName === 'entradas' ? apiEntradas : apiSalidas;
            const urlParams = new URLSearchParams();
            if (q) urlParams.set('q', q);
            urlParams.set('per_page', perPage);
            const pageParam = tabName === 'entradas' ? 'page_e' : 'page_s';
            const pageValue = paramsObj && paramsObj[pageParam] ? paramsObj[pageParam] : 1;
            urlParams.set(pageParam, pageValue);

            fetch(`${url}?${urlParams.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.json())
                .then(json => {
                    renderTable(tabName, json);
                    // Actualiza conteos en los tabs para reflejar el total
                    if (tabName === 'entradas' && tabEntradasBtn) {
                        tabEntradasBtn.innerHTML = `Entradas (${json.count})`;
                    }
                    if (tabName === 'salidas' && tabSalidasBtn) {
                        tabSalidasBtn.innerHTML = `Salidas (${json.count})`;
                    }
                    // Actualiza URL amigable (con tab, q y page)
                    const stateParams = new URLSearchParams();
                    stateParams.set('tab', tabName);
                    if (q) stateParams.set('q', q);
                    stateParams.set('per_page', perPage);
                    stateParams.set(pageParam, pageValue);
                    history.replaceState(null, '', `?${stateParams.toString()}`);
                })
                .catch(err => {
                    targetDiv.innerHTML = `<div class="alert alert-danger">Error al cargar ${tabName}. Intente recargar la página.</div>`;
                    console.error('API Load Error:', err);
                });
        }

        // --- 1. Manejo del click en pestañas ---
        movimientosTab.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.tabName) {
                const newTabName = button.dataset.tabName;
                
                // Si la pestaña no estaba activa, forzamos la carga AJAX y reseteamos la paginación a la página 1
                if (newTabName !== currentTab) {
                    loadContent(newTabName, {});
                }
            }
        });

        // --- 2. Manejo de la paginación (Delegación de eventos) ---
        // Escucha clics en TODA el área de contenido del tab
        document.getElementById('movimientosTabContent').addEventListener('click', (e) => {
            const link = e.target.closest('a.page-link');
            if (link && link.closest('.pagination')) {
                e.preventDefault();
                const nextPage = parseInt(link.dataset.page, 10);
                const param = link.dataset.param;
                if (!isNaN(nextPage) && nextPage > 0) {
                    const paramsObj = {}; paramsObj[param] = nextPage;
                    loadContent(currentTab, paramsObj);
                }
            }
        });

        // Cambio de per_page dispara recarga de pestaña activa
        if (perPageSelect) {
            perPageSelect.addEventListener('change', () => loadContent(currentTab, {}));
        }

        // --- 3. Ejecutar la carga inicial de la pestaña activa (si no fue precargada) ---
        // Reemplazamos por carga inicial desde API, manteniendo la UI coherente
        loadContent(currentTab, {});

        // --- 4. Actualizar action de formularios dinámicos antes de SweetAlert2 ---
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-confirm-delete="true"]');
            if (!btn) return;
            
            const form = btn.closest('form');
            if (!form) return;
            
            // Si el formulario tiene data-entry-id, actualizar el action antes de que SweetAlert2 lo procese
            const entryId = form.dataset.entryId;
            if (entryId && form.action.includes('/0/')) {
                form.action = form.action.replace('/0/', `/${entryId}/`);
            }
        }, true); // useCapture = true para ejecutar ANTES que el listener de base.html
    });
</script>

<!-- jQuery (requerido por Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Configuración de Select2 para Insumos -->
<script src="{% static 'js/insumo-select2.js' %}"></script>

<script>
    // Inicializar Select2 en el filtro de insumos
    const apiUrl = "{% url 'inventario:api_buscar_insumos' %}";
    document.addEventListener('DOMContentLoaded', function() {
        const insumoFilter = document.getElementById('insumo-filter');
        if (insumoFilter) {
            $(insumoFilter).select2({
                theme: 'bootstrap-5',
                placeholder: 'Seleccionar insumo (opcional)',
                allowClear: true,
                width: '100%',
                language: {
                    noResults: function() {
                        return "No se encontraron insumos";
                    },
                    searching: function() {
                        return "Buscando...";
                    },
                    inputTooShort: function() {
                        return "Escribe para buscar";
                    },
                    loadingMore: function() {
                        return "Cargando más resultados...";
                    }
                },
                ajax: {
                    url: apiUrl,
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            page: params.page || 1
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results,
                            pagination: data.pagination
                        };
                    },
                    cache: true
                },
                minimumInputLength: 0
            });
        }
    });
</script>
{% endblock extra_js %}