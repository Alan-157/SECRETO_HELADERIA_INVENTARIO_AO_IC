{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">{{ titulo }}</h3>
  {# No hay botón de "nuevo lote" (aún). Respetamos read_only para coherencia #}
  {% if not read_only %}
    <span class="text-muted small">Gestión desde movimientos/órdenes</span>
  {% endif %}
</div>

<div class="d-flex justify-content-between align-items-center mb-3">

  {# ================== FORMULARIO DE FILTROS ================== #}
  <form id="filters-form" class="row g-2" method="get" style="flex-grow: 1;">
    <div class="col-12 col-md-4">
      <input id="q-input"
             name="q"
             type="text"
             class="form-control"
             placeholder="Buscar por insumo o bodega..."
             value="{{ q|default:'' }}">
    </div>

    <div class="col-6 col-md-3">
      <select name="sort" id="sort-select" class="form-select">
        <option value="insumo"   {% if sort == 'insumo' %}selected{% endif %}>Ordenar por: Insumo</option>
        <option value="bodega"   {% if sort == 'bodega' %}selected{% endif %}>Ordenar por: Bodega</option>
        <option value="fingreso" {% if sort == 'fingreso' %}selected{% endif %}>Ordenar por: F. Ingreso</option>
        <option value="fexpira"  {% if sort == 'fexpira' %}selected{% endif %}>Ordenar por: F. Expiración</option>
        <option value="cact"     {% if sort == 'cact' %}selected{% endif %}>Ordenar por: Cant. Actual</option>
        <option value="cini"     {% if sort == 'cini' %}selected{% endif %}>Ordenar por: Cant. Inicial</option>
      </select>
    </div>

    <div class="col-6 col-md-2">
      <select name="order" id="order-select" class="form-select">
        <option value="asc"  {% if order == 'asc' %}selected{% endif %}>Ascendente ↑</option>
        <option value="desc" {% if order == 'desc' %}selected{% endif %}>Descendente ↓</option>
      </select>
    </div>

    {# Filtro de vencimiento #}
    <div class="col-6 col-md-2">
      <select name="vencimiento" id="vencimiento-select" class="form-select">
        <option value="todos"    {% if filtro_vencimiento == 'todos' %}selected{% endif %}>Todos</option>
        <option value="proximos" {% if filtro_vencimiento == 'proximos' %}selected{% endif %}>
          Próximos a vencer
        </option>
      </select>
    </div>

    <div class="col-6 col-md-1">
      <input type="number"
             min="1" max="365"
             name="dias"
             id="dias-input"
             class="form-control"
             value="{{ dias_proximos|default:30 }}"
             title="Días para considerar como 'próximos a vencer'">
    </div>

    {# per_page #}
    <div class="col-6 col-md-1">
      <select name="per_page" id="per-page-select" class="form-select">
        <option value="10"  {% if per_page == 10 %}selected{% endif %}>10</option>
        <option value="25"  {% if per_page == 25 %}selected{% endif %}>25</option>
        <option value="50"  {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
      </select>
    </div>

    <div class="col-6 col-md-1">
      <button class="btn btn-outline-primary w-100" type="submit">Aplicar</button>
    </div>

    <input type="hidden" id="page-input" name="page" value="{{ lotes.number|default:'1' }}">
  </form>

  {# ================== DROPDOWN EXPORTAR ================== #}
  <div class="ms-4">
    <div class="dropdown">
      <button class="btn btn_success fw-bold dropdown-toggle" type="button"
              data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 120px;">
        <i class="fas fa-file-export me-2"></i> Exportar
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li>
          <h6 class="dropdown-header">Todos los lotes</h6>
        </li>
        <li>
          <a class="dropdown-item" id="export-excel"
             href="{% url 'inventario:exportar_lotes' %}?exportar=excel">
            <i class="fas fa-file-excel text-success me-2"></i> Exportar Excel
          </a>
        </li>
        <li>
          <a class="dropdown-item" id="export-pdf"
             href="{% url 'inventario:exportar_lotes' %}?exportar=pdf">
            <i class="fas fa-file-pdf text-danger me-2"></i> Exportar PDF
          </a>
        </li>

        <li><hr class="dropdown-divider"></li>

        <li>
          <h6 class="dropdown-header">
            Próximos a vencer{% if dias_proximos %} ({{ dias_proximos }} días){% endif %}
          </h6>
        </li>
        <li>
          <a class="dropdown-item" id="export-excel-proximos"
             href="{% url 'inventario:exportar_lotes' %}?exportar=excel&proximos=1">
            <i class="fas fa-hourglass-half text-warning me-2"></i>
            Excel – Próximos a vencer
          </a>
        </li>
        <li>
          <a class="dropdown-item" id="export-pdf-proximos"
             href="{% url 'inventario:exportar_lotes' %}?exportar=pdf&proximos=1">
            <i class="fas fa-hourglass-half text-danger me-2"></i>
            PDF – Próximos a vencer
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

<div id="results">
  {% include "inventario/partials/insumo_lote_results.html" %}
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form           = document.getElementById('filters-form');
  const results        = document.getElementById('results');
  const qInput         = document.getElementById('q-input');
  const sortSelect     = document.getElementById('sort-select');
  const orderSelect    = document.getElementById('order-select');
  const vencSelect     = document.getElementById('vencimiento-select');
  const diasInput      = document.getElementById('dias-input');
  const perPageSelect  = document.getElementById('per-page-select');
  const pageInput      = document.getElementById('page-input');

  const exportExcelLink      = document.getElementById('export-excel');
  const exportPdfLink        = document.getElementById('export-pdf');
  const exportExcelProxLink  = document.getElementById('export-excel-proximos');
  const exportPdfProxLink    = document.getElementById('export-pdf-proximos');

  const buildURL = () => {
    const params = new URLSearchParams(new FormData(form));
    return `${location.pathname}?${params.toString()}`;
  };

  // Actualizar enlaces de exportación según la URL actual
  const updateExportLinks = () => {
    const currentParams = new URLSearchParams(window.location.search);
    const q     = currentParams.get('q') || '';
    const sort  = currentParams.get('sort') || '';
    const order = currentParams.get('order') || '';
    const venc  = currentParams.get('vencimiento') || '';
    const dias  = currentParams.get('dias') || '';

    // --- Todos los lotes ---
    let urlExcel  = exportExcelLink.href.split('?')[0];
    let paramsEx  = new URLSearchParams();
    paramsEx.set('exportar', 'excel');
    if (q)     paramsEx.set('q', q);
    if (sort)  paramsEx.set('sort', sort);
    if (order) paramsEx.set('order', order);
    exportExcelLink.href = urlExcel + '?' + paramsEx.toString();

    let urlPdf  = exportPdfLink.href.split('?')[0];
    let paramsPdf = new URLSearchParams();
    paramsPdf.set('exportar', 'pdf');
    if (q)     paramsPdf.set('q', q);
    if (sort)  paramsPdf.set('sort', sort);
    if (order) paramsPdf.set('order', order);
    exportPdfLink.href = urlPdf + '?' + paramsPdf.toString();

    // --- Próximos a vencer ---
    if (exportExcelProxLink) {
      let urlExProx   = exportExcelProxLink.href.split('?')[0];
      let paramsExProx = new URLSearchParams();
      paramsExProx.set('exportar', 'excel');
      paramsExProx.set('proximos', '1');
      if (q)     paramsExProx.set('q', q);
      if (sort)  paramsExProx.set('sort', sort);
      if (order) paramsExProx.set('order', order);
      if (dias)  paramsExProx.set('dias', dias);
      exportExcelProxLink.href = urlExProx + '?' + paramsExProx.toString();
    }

    if (exportPdfProxLink) {
      let urlPdfProx   = exportPdfProxLink.href.split('?')[0];
      let paramsPdfProx = new URLSearchParams();
      paramsPdfProx.set('exportar', 'pdf');
      paramsPdfProx.set('proximos', '1');
      if (q)     paramsPdfProx.set('q', q);
      if (sort)  paramsPdfProx.set('sort', sort);
      if (order) paramsPdfProx.set('order', order);
      if (dias)  paramsPdfProx.set('dias', dias);
      exportPdfProxLink.href = urlPdfProx + '?' + paramsPdfProx.toString();
    }
  };

  async function loadAjax(url){
    const resp = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    if (!resp.ok) return;
    const data = await resp.json();
    results.innerHTML = data.html;
    history.replaceState({}, "", url);
    updateExportLinks();
  }

  const debounce = (fn, ms = 350) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  };

  // Buscador
  qInput.addEventListener('input', debounce(() => {
    pageInput.value = "1";
    loadAjax(buildURL());
  }));

  // Orden, dirección, vencimiento, días, per_page
  sortSelect.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  orderSelect.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  vencSelect.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  diasInput.addEventListener('change', () => {
    pageInput.value = "1";
    loadAjax(buildURL());
  });

  if (perPageSelect) {
    perPageSelect.addEventListener('change', () => {
      pageInput.value = "1";
      loadAjax(buildURL());
    });
  }

  // Paginación AJAX
  results.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-ajax-link]');
    if (a) {
      e.preventDefault();
      loadAjax(a.href);
    }
  });

  // Inicializar enlaces de exportación al cargar
  updateExportLinks();
})();
</script>
{% endblock %}
