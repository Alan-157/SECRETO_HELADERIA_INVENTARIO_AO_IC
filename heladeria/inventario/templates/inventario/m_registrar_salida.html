{% extends "base.html" %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <h3 class="mb-0">{{ titulo }}</h3>
                <button id="add-line-salida" type="button" class="btn btn-sm btn-danger" title="➕ Agregar nueva línea de salida">
                    <i class="bi bi-plus-circle"></i> ➕ Agregar Línea
                </button>
            </div>

            <div class="card-body">
                {# NUEVO: Mostrar información de la orden si existe precarga #}
                {% if orden %}
                    <div class="alert alert-info">
                        Atendiendo Orden de Salida <strong>#{{ orden.id }}</strong> (Tipo: {{ orden.tipo_orden }}). Los insumos pendientes han sido precargados.
                        {% if orden.estado == 'PENDIENTE' %}
                        <p class="mb-0 mt-1 small">Recuerde que esta salida **vinculará** los movimientos a la orden y actualizará su estado.</p>
                        {% endif %}
                        <input type="hidden" name="orden_id" value="{{ orden.id }}">
                    </div>
                {% endif %}
                <form method="post" novalidate>
                    {% csrf_token %}
                    {{ formset.management_form }}
                    
                    {# MUESTRA ERRORES GLOBALES #}
                    {% if formset.non_form_errors %}
                        <div class="alert alert-danger">
                            <strong>Errores Generales:</strong>
                            <ul>
                                {% for error in formset.non_form_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    {# 1. FORMULARIO DE PLANTILLA OCULTO PARA CLONAR #}
                    <div id="empty-form-template-salida" style="display: none;">
                        {# Se usa formset.empty_form para clonar la estructura #}
                        {% include "inventario/partials/salida_linea_form.html" with form=formset.empty_form prefix="__prefix__" %}
                    </div>

                    <div id="formset-body-salida">
                        {% for f in formset %}
                            {% include "inventario/partials/salida_linea_form.html" with form=f prefix=forloop.counter0 %}
                        {% empty %}
                            {# Se mostrará vacío o se llenará con la plantilla si el 'extra' es 1 #}
                        {% endfor %}
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{% url 'inventario:listar_movimientos' %}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-save"></i> Registrar Salida
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    const STOCK_INFO_URL_TEMPLATE = "{% url 'inventario:get_insumo_stock_info' insumo_id=0 %}".replace('/0/', '/{insumo_id}/');
    const LOTES_API_URL = "{% url 'inventario:api_obtener_lotes_por_insumo' %}";

    function cargarLotesPorInsumo(formRow) {
        const insumoSelect = formRow.querySelector('[name$="-insumo"]');
        const loteSelect = formRow.querySelector('[name$="-insumo_lote"]');
        const ubicacionSelect = formRow.querySelector('[name$="-ubicacion"]');
        
        if (!insumoSelect || !loteSelect) return;
        
        const insumoId = insumoSelect.value;
        const ubicacionId = ubicacionSelect ? ubicacionSelect.value : null;
        
        // Limpiar y deshabilitar el selector de lotes si no hay insumo
        if (!insumoId) {
            loteSelect.innerHTML = '<option value="">Seleccione primero un insumo</option>';
            loteSelect.disabled = true;
            return;
        }
        
        // Mostrar cargando
        loteSelect.innerHTML = '<option value="">Cargando lotes...</option>';
        loteSelect.disabled = true;
        
        // Construir URL con parámetros
        let url = `${LOTES_API_URL}?insumo_id=${insumoId}`;
        if (ubicacionId) {
            url += `&ubicacion_id=${ubicacionId}`;
        }
        
        // Cargar lotes por AJAX
        fetch(url)
            .then(response => response.json())
            .then(data => {
                loteSelect.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    // Agregar opción por defecto
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Seleccione un lote';
                    loteSelect.appendChild(defaultOption);
                    
                    // Agregar lotes disponibles
                    data.results.forEach(lote => {
                        const option = document.createElement('option');
                        option.value = lote.id;
                        option.textContent = lote.text;
                        option.dataset.cantidad = lote.cantidad_disponible;
                        option.dataset.bodegaId = lote.bodega_id;
                        loteSelect.appendChild(option);
                    });
                    
                    loteSelect.disabled = false;
                } else {
                    loteSelect.innerHTML = '<option value="">No hay lotes disponibles</option>';
                    loteSelect.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error al cargar lotes:', error);
                loteSelect.innerHTML = '<option value="">Error al cargar lotes</option>';
                loteSelect.disabled = true;
            });
    }

    function updateCardBorder(formRow, status) {
        const card = formRow.closest('.movimiento-card');
        if (!card) return;
        
        card.classList.remove('border-success', 'border-warning', 'border-danger', 'border-secondary');
        const hasFormErrors = card.classList.contains('border-danger'); 
        if (hasFormErrors) return; 

        switch(status) {
            case 'OK':
                card.classList.add('border-success');
                break;
            case 'BAJO_STOCK': 
            case 'STOCK_EXCESIVO': 
            case 'SIN_STOCK': 
                card.classList.add('border-danger');
                break;
            default:
                card.classList.add('border-secondary');
        }
    }

    function setupLoteUbicacionSync(formRow) {
        const loteSelect = formRow.querySelector('[name$="-insumo_lote"]');
        const ubicacionSelect = formRow.querySelector('[name$="-ubicacion"]');
        
        if (!loteSelect || !ubicacionSelect) return;
        
        loteSelect.addEventListener('change', () => {
            const selectedOption = loteSelect.options[loteSelect.selectedIndex];
            const bodegaId = selectedOption?.dataset?.bodegaId;
            
            if (bodegaId) {
                // Buscar ubicación que pertenezca a esta bodega
                for (let i = 0; i < ubicacionSelect.options.length; i++) {
                    const option = ubicacionSelect.options[i];
                    // Las opciones de ubicación deben tener el formato "Nombre (Bodega: ...)"
                    // O podemos verificar por el value y consultar
                    // Por simplicidad, seleccionamos la primera ubicación de la bodega
                    if (option.dataset.bodegaId === bodegaId) {
                        ubicacionSelect.value = option.value;
                        break;
                    }
                }
            }
        });
    }

    function setupStockInfoListener(formRow) {
        const insumoSelect = formRow.querySelector('[name$="-insumo"]'); 
        const stockDisplay = formRow.querySelector('.js-stock-info-display');
        
        if (!insumoSelect || !stockDisplay) return;

        const fetchStockInfo = () => {
            const insumoId = insumoSelect.value;
            if (!insumoId) {
                stockDisplay.innerHTML = '<span class="text-muted small">Seleccione un insumo.</span>';
                updateCardBorder(formRow, 'DEFAULT');
                return;
            }

            const url = STOCK_INFO_URL_TEMPLATE.replace('{insumo_id}', insumoId);
            stockDisplay.innerHTML = '<span class="text-primary small">Cargando informacion...</span>';

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Error del servidor.'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        stockDisplay.innerHTML = `
                            <div class="alert alert-sm alert-stock p-2 mt-2" data-status="${data.status}" role="alert">
                                ${data.mensaje_ayuda}
                                <hr class="my-1">
                                <small>Stock actual: <b>${data.stock_actual.toFixed(2)} ${data.unidad_medida}</b>. Maximo: ${data.stock_maximo.toFixed(2)}.</small>
                            </div>
                        `;
                        updateCardBorder(formRow, data.status);
                    } else {
                        stockDisplay.innerHTML = `<span class="text-danger small">${data.message}</span>`;
                        updateCardBorder(formRow, 'DEFAULT');
                    }
                })
                .catch(error => {
                    stockDisplay.innerHTML = `<span class="text-danger small">Error al conectar: ${error.message}</span>`;
                    updateCardBorder(formRow, 'DEFAULT');
                });
        };
        
        // Ejecutar al cargar si el campo ya tiene un valor (ej. precarga de orden)
        if (insumoSelect.value) {
            fetchStockInfo();
            cargarLotesPorInsumo(formRow);
        }
        
        // Cuando cambie el insumo, actualizar stock Y cargar lotes
        insumoSelect.addEventListener('change', () => {
            fetchStockInfo();
            cargarLotesPorInsumo(formRow);
        });
        
        // También actualizar lotes si cambia la ubicación
        const ubicacionSelect = formRow.querySelector('[name$="-ubicacion"]');
        if (ubicacionSelect) {
            ubicacionSelect.addEventListener('change', () => {
                if (insumoSelect.value) {
                    cargarLotesPorInsumo(formRow);
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const formsetBody = document.getElementById('formset-body-salida');
        const addLineBtn = document.getElementById('add-line-salida');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const emptyFormTpl = document.getElementById('empty-form-template-salida'); 
        const apiUrl = "{% url 'inventario:api_buscar_insumos' %}";

        // 1. Inicializar Select2 en los selectores de insumo existentes
        window.initializeAllInsumoSelects(apiUrl);

        // 2. Configurar listeners de stock y carga de lotes para las líneas existentes (precargadas)
        document.querySelectorAll('#formset-body-salida .movimiento-card').forEach(row => {
            setupStockInfoListener(row);
            setupLoteUbicacionSync(row);
            // Si la línea ya tiene insumo seleccionado, cargar sus lotes
            const insumoSelect = row.querySelector('[name$="-insumo"]');
            if (insumoSelect && insumoSelect.value) {
                cargarLotesPorInsumo(row);
            }
        });
        
        // 3. Función para manejar la adición de nuevas líneas
        addLineBtn.addEventListener('click', function() {
            const index = parseInt(totalForms.value, 10);
            
            // Clonar el contenido HTML de la plantilla oculta
            let newFormHtml = emptyFormTpl.innerHTML.replace(/__prefix__/g, index);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml.trim();
            const newRow = tempDiv.firstElementChild; // Tomamos el primer hijo (la card)

            // Limpiar valores por defecto
            const qtyInput = newRow.querySelector('[name$="-cantidad"]');
            if (qtyInput) qtyInput.value = '';
            
            // Quitar las clases de borde de éxito/error y poner la default
            newRow.classList.remove('border-success', 'border-warning', 'border-danger');
            newRow.classList.add('border-secondary');
            
            formsetBody.appendChild(newRow);
            totalForms.value = index + 1;
            
            // Inicializar Select2 en el nuevo selector de insumo
            const newInsumoSelect = newRow.querySelector('select[name$="-insumo"]');
            if (newInsumoSelect && !newInsumoSelect.hasAttribute('disabled')) {
                window.initializeInsumoSelect2(newInsumoSelect, apiUrl);
            }
            
            // Re-vincular el listener de stock y carga de lotes a la nueva línea
            setupStockInfoListener(newRow);
            setupLoteUbicacionSync(newRow);
        });

        // 4. Manejo de eliminación (adaptado a los selectores usados en los parciales)
        formsetBody.addEventListener('click', (e) => {
            const delBtn = e.target.closest('.del-line');
            const markDelBtn = e.target.closest('.mark-delete-line');
            let row;
            let deleteInput;
            
            if (delBtn) {
                row = delBtn.closest('.movimiento-card');
                deleteInput = row.querySelector('[name$="-DELETE"]');
                
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                }
            } else if (markDelBtn) {
                row = markDelBtn.closest('.movimiento-card');
                deleteInput = row.querySelector('[name$="-DELETE"]');
                
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.classList.add('border-danger');
                    row.style.opacity = '0.5';
                    markDelBtn.style.display = 'none'; 
                }
            }
        });
    });
</script>

<style>
    .alert-sm { padding: 0.5rem; margin-bottom: 0; font-size: 0.875rem; }
    .alert-sm .my-1 { margin-top: 0.25rem !important; margin-bottom: 0.25rem !important; border-top: 1px solid #dcdcdc; }
    .alert-stock[data-status="SIN_STOCK"] { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .alert-stock[data-status="BAJO_STOCK"] { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
    .alert-stock[data-status="STOCK_EXCESIVO"] { background-color: #cce5ff; color: #004085; border-color: #b8daff; }
    .alert-stock[data-status="OK"] { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
</style>
{% endblock extra_js %}
