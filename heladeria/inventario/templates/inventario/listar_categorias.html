{% extends "base.html" %}
{% block title %}Categor√≠as{% endblock %}
{% block content %}
<div class="container mt-3">
  <h3>Categor√≠as</h3>

  {% if not read_only %}
    <a href="{% url 'inventario:crear_categoria' %}" class="btn btn-primary mb-3">‚ûï Nueva Categor√≠a</a>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <form method="get" id="filterForm" class="d-flex gap-2">
      <input type="text" name="q" value="{{ q }}" placeholder="Buscar..." class="form-control">
      <select name="order" class="form-select">
        <option value="asc" {% if order == 'asc' %}selected{% endif %}>A-Z</option>
        <option value="desc" {% if order == 'desc' %}selected{% endif %}>Z-A</option>
      </select>
      <select name="per_page" class="form-select">
        <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
      </select>
      <button type="submit" class="btn btn-secondary">Filtrar</button>
    </form>
  </div>

  <div id="resultados">
    {% include 'inventario/partials/categorias_results.html' %}
  </div>
</div>

<script>
(function(){
  const form = document.getElementById("filterForm");
  const results = document.getElementById("resultados");

  const qInput      = form.querySelector('input[name="q"]');
  const orderSelect = form.querySelector('select[name="order"]');
  const perSelect   = form.querySelector('select[name="per_page"]');

  const buildURL = () => {
    const params = new URLSearchParams(new FormData(form));
    return `${location.pathname}?${params.toString()}`;
  };

  async function loadAjax(url){
    try {
      const res = await fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      if (!res.ok) return;

      // üîë AHORA S√ç: leemos JSON
      const data = await res.json();
      results.innerHTML = data.html;
      history.replaceState({}, "", url);
    } catch (err) {
      console.error("Error AJAX categor√≠as:", err);
    }
  }

  const debounce = (fn, ms = 350) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  };

  // Buscar mientras escribes en el input
  qInput.addEventListener("input", debounce(() => {
    loadAjax(buildURL());
  }));

  // Cambios en order / per_page
  [orderSelect, perSelect].forEach(el => {
    el.addEventListener("change", () => {
      loadAjax(buildURL());
    });
  });

  // Paginaci√≥n por AJAX (links con data-ajax-link en el partial)
  results.addEventListener("click", (e) => {
    const a = e.target.closest("a[data-ajax-link]");
    if (!a) return;
    e.preventDefault();
    loadAjax(a.href);
  });
})();
</script>
{% endblock %}
