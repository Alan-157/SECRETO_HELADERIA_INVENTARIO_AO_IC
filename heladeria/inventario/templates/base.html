{% load static %}
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{% block title %}Secreto Inventario{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/app.css' %}" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <style>
        body {
            background-color: #F5F5DC; /* Código HEX para el color Beige Suave (Cornsilk) */
        }
    </style>
    </head>
<body> {% include "_partials/navbar.html" %}

    <main class="container py-4">
        {# BLOQUE DE MENSAJES ESTÁTICOS ELIMINADO: El SweetAlert2 lo manejará globalmente #}

        {% block content %}
        {% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery requerido por Select2 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script src="{% static 'js/app.js' %}" async></script>
    <script src="{% static 'js/paginadores.js' %}"></script>
    <script src="{% static 'js/insumo-select2.js' %}"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'js/confirmaciones.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    
    // Lógica para el manejo de mensajes de Django (Inicio de Sesión y otros mensajes post-redirección)
    {% if messages %}
        {% for message in messages %}
            
            let iconType;
            let titleText;
            
            // Mapeo de tags de Django a SweetAlert2
            if ("{{ message.tags }}" === "success") {
                iconType = 'success';
                titleText = '✅ Autorizado';
            } else if ("{{ message.tags }}" === "error") {
                iconType = 'error';
                titleText = '❌ Denegado';
            } else {
                iconType = 'info';
                titleText = 'Mensaje';
            }

            // Disparar SweetAlert2 como Toast en la esquina superior
            // Esto se ejecuta en cualquier página que recibe un mensaje (incluyendo el dashboard después del login)
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: iconType,
                    title: titleText,
                    text: "{{ message|safe }}", // El mensaje completo de Django
                    timer: 3000, 
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }
        {% endfor %}
    {% endif %}


    // Lógica para botones de eliminación que requieren confirmación (Categorías, Órdenes, etc.)
    // USANDO DELEGACIÓN DE EVENTOS para soportar elementos generados dinámicamente
    document.addEventListener("click", function (e) {
        const btn = e.target.closest("[data-confirm-delete='true']");
        if (!btn) return;
        
        e.preventDefault();
        
        const form = btn.closest("form");
        if (!form) return;
        
        // Obtener información para la alerta
        const nombre = btn.getAttribute('data-objeto-nombre') || "este elemento";
        const tipo = btn.getAttribute('data-objeto-tipo') || "elemento";

        Swal.fire({
            title: `¿Estás seguro de eliminar ${tipo} «${nombre}»?`,
            text: "Esta acción marcará el elemento como inactivo y no se puede deshacer.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#A41C2D", 
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar"
        }).then((result) => {
            if (result.isConfirmed) {
                
                // Si el formulario tiene el atributo data-ajax="true", se envía con AJAX
                if (form.dataset.ajax === "true") {
                    fetch(form.action, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value,
                            "X-Requested-With": "XMLHttpRequest",
                        },
                    })
                    .then(res => res.json())
                    .then(data => {
                        Swal.fire("Eliminado", data.message || "El elemento fue eliminado.", "success")
                            .then(() => location.reload());
                    })
                    .catch(() => {
                        Swal.fire("Error", "No se pudo eliminar el elemento.", "error");
                    });
                } else {
                    // Envío normal del formulario (POST a la vista de eliminación)
                    form.submit();
                }
            }
        });
    });
    
    // Lógica para el antiguo data-delete-form (Dejada para compatibilidad con el código anterior)
    document.querySelectorAll("[data-delete-form]").forEach((btn) => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();
            const form = this.closest("form"); 

            Swal.fire({
                 title: "¿Estás seguro?",
                 text: "Esta acción no se puede deshacer.",
                 icon: "warning",
                 showCancelButton: true,
                 confirmButtonColor: "#A41C2D",
                 cancelButtonColor: "#6c757d",
                 confirmButtonText: "Sí, eliminar",
                 cancelButtonText: "Cancelar"
            }).then((result) => {
                 if (result.isConfirmed) {
                     if (form.dataset.ajax === "true") {
                          fetch(form.action, {
                              method: "POST",
                              headers: {
                                  "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value,
                                  "X-Requested-With": "XMLHttpRequest",
                              },
                          })
                          .then(res => res.json())
                          .then(data => {
                              Swal.fire("Eliminado", data.message || "El elemento fue eliminado.", "success")
                                  .then(() => location.reload());
                          })
                          .catch(() => {
                              Swal.fire("Error", "No se pudo eliminar el elemento.", "error");
                          });
                      } else {
                          form.submit();
                      }
                 }
            });
        });
    });
});
</script>

    {% block extra_js %}{% endblock %}
</body>
</html>