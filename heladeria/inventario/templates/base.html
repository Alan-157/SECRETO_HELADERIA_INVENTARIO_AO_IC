{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Secreto Inventario{% endblock %}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">

  {% block extra_css %}{% endblock %}
</head>

<body class="bg-light">
  {% include "_partials/navbar.html" %}

  <main class="container py-4">
    {% if messages %}
      <div class="container mb-3" id="django-messages">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-2 alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/app.js' %}"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {

    // Auto-cerrar alerts de Django (opcional)
    const msgWrap = document.getElementById("django-messages");
    if (msgWrap) {
      setTimeout(() => {
        msgWrap.querySelectorAll(".alert").forEach(a => {
          try { bootstrap.Alert.getOrCreateInstance(a).close(); } catch(e){}
        });
      }, 5000);
    }

    // Confirmación SweetAlert2 para "eliminar" (ocultamiento lógico)
    document.querySelectorAll("[data-delete-form]").forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const form = this.closest("form");
        if (!form) return;

        const title   = this.dataset.deleteTitle   || "¿Ocultar registro?";
        const text    = this.dataset.deleteText    || "Esto desactivará el elemento (no se borra de la BD).";
        const confirm = this.dataset.deleteConfirm || "Sí, ocultar";
        const cancel  = this.dataset.deleteCancel  || "Cancelar";

        Swal.fire({
          title: title,
          text: text,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#A41C2D",
          cancelButtonColor: "#6c757d",
          confirmButtonText: confirm,
          cancelButtonText: cancel
        }).then((result) => {
          if (!result.isConfirmed) return;

          // Si es AJAX, se maneja la respuesta
          if (form.dataset.ajax === "true") {
            fetch(form.action, {
              method: "POST",
              credentials: "same-origin",
              headers: {
                "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]")?.value,
                "X-Requested-With": "XMLHttpRequest",
              },
            })
            .then(async (res) => {
              // Intentar JSON; si no, devolvemos objeto vacío
              try {
                const data = await res.json();
                return { ok: res.ok, data };
              } catch (e) {
                return { ok: res.ok, data: {} };
              }
            })
            .then(({ ok, data }) => {
              if (!ok) throw new Error("Respuesta no OK");

              Swal.fire(
                "Ocultado",
                data.message || "El elemento fue desactivado correctamente.",
                "success"
              ).then(() => location.reload());
            })
            .catch(() => {
              Swal.fire("Error", "No se pudo desactivar el elemento.", "error");
            });

          } else {
            // Envío normal del formulario (no AJAX)
            form.submit();
          }
        });
      });
    });
  });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
